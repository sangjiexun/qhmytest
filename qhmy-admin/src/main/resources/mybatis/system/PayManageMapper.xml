<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="PayManageMapper">

<!--begin 其它缴费项目设置模块 sql -->
    
	<!-- 保存其它缴费项 -->
	<insert id="saveOtherPayItem" parameterType="pd">
		INSERT INTO 
		T_PAY_OTHER_ITEM
		(PKID,PAYITEM,ITEM_TYPE,UPDATEPROFESSION,UPDATEPAYITEM,CJSJ,XGSJ,CJR,XGR,STATUS)
		VALUES 
		(#{PKID},#{PAYITEM},1,#{UPDATEPROFESSION},#{UPDATEPAYITEM},SYSDATE,SYSDATE,#{CJR},#{XGR},1)
	</insert>
	<select id="getItemInfo" parameterType="pd" resultType="pd">
		select i.*,s.PAY_STYLE_NAME
		from t_pay_item i
		join t_pay_style s on s.pkid = i.PAY_TYPE_PKID 
		where i.pkid = #{item_pkid}
	</select>
	
	<select id="getLastGrade" parameterType="pd" resultType="pd">
		select * from 
		SYS_DICTIONARIES D 
		WHERE D.NAME = (
			SELECT TO_CHAR(add_months(TO_DATE(DS.NAME,'YYYY'),-12),'YYYY') NAME FROM SYS_DICTIONARIES DS WHERE DS.DICTIONARIES_ID = #{GRADE}
		)
		AND D.PARENT_ID = 'GRADE'
	</select>
	<select id="getSendMsgCounts" parameterType="pd" resultType="pd">
		select COUNT(*) AS totalcount,
    nvl(SUM(
    CASE 
    WHEN b.wx_openid IS NOT NULL
    THEN 1
    END 
    ),0) AS sendcount
     
    from t_pay_item_list a JOIN t_student b ON a.student_pkid=b.pkid  join t_Student_Bm s on a.STUDENT_BM_PKID = s.PKID
    WHERE a.status=0 and s.zhuangtai='1' AND a.T_PAY_ITEM_PKID=#{payitempkid} 
	</select>
	
	<select id="findpkbyid" parameterType="pd" resultType="pd">
	 select * from T_STUDENT_BM t
	 join t_student s on s.pkid = t.STUDENT_PKID
	 where t.ZHUANGTAI=1 and  s.SHENFENZHENGHAO=#{SHENFENZHENGHAO} 
	 and t.BANJI_TYPE_PKID = #{CLASSTYPE_PKID}
	 and t.RXNIANFEN_PKID = #{GRADE_PKID}
	 and ROWNUM = 1
	</select>
	<select id="getaddStutableyjlistPage" parameterType="pd" resultType="pd">
		select S.XINGMING,SB.PKID,SB.STUDENT_PKID,SB.XUEHAO,S.SHENFENZHENGHAO,d.NAME AS GRADE_NAME,DS.NAME AS CLASSTYPE_NAME,
		C.CLASS_NAME
		from T_STUDENT_BM SB
		LEFT JOIN T_CLASS C ON C.PKID = SB.BANJI
		join t_student s on s.pkid = SB.STUDENT_PKID AND S.YJ_STUBM_PKID = SB.PKID
		JOIN T_PAY_ITEM I ON I.GRADE_PKID = S.YJ_NIANFEN AND I.CLASSTYPE_PKID = S.YJ_BANJI_TYPE_PKID
		JOIN SYS_DICTIONARIES d on d.DICTIONARIES_ID = SB.RXNIANFEN_PKID and d.PARENT_ID = 'GRADE'
        JOIN SYS_DICTIONARIES DS ON DS.DICTIONARIES_ID = SB.BANJI_TYPE_PKID AND DS.PARENT_ID = 'CLASSTYPE'
		WHERE I.PKID = #{pd.item_pkid} and SB.ZXZT='ZX'  and SB.ZHUANGTAI='1' and sb.is_tongguo!=0
		and not exists 
		(select 1 from t_pay_item_list l where l.STUDENT_BM_PKID = SB.PKID AND L.T_PAY_ITEM_PKID = I.PKID)
		<if test="pd.seText!=null and pd.seText!=''">
			and ( S.SHENFENZHENGHAO LIKE CONCAT('%',CONCAT(#{pd.seText},'%'))
				OR S.XINGMING LIKE CONCAT('%',CONCAT(#{pd.seText},'%'))
				OR SB.XUEHAO LIKE CONCAT('%',CONCAT(#{pd.seText},'%'))) 
		</if>
	</select>
	<select id="getaddStutablelistPage" parameterType="pd" resultType="pd">
		select S.XINGMING,SB.PKID,SB.STUDENT_PKID,SB.XUEHAO,S.SHENFENZHENGHAO,d.NAME AS GRADE_NAME,DS.NAME AS CLASSTYPE_NAME,
		C.CLASS_NAME
		from T_STUDENT_BM SB
		LEFT JOIN T_CLASS C ON C.PKID = SB.BANJI
		join t_student s on s.pkid = SB.STUDENT_PKID
		JOIN T_PAY_ITEM I ON I.GRADE_PKID = SB.RXNIANFEN_PKID AND I.CLASSTYPE_PKID = SB.BANJI_TYPE_PKID
		JOIN SYS_DICTIONARIES d on d.DICTIONARIES_ID = I.GRADE_PKID and d.PARENT_ID = 'GRADE'
        JOIN SYS_DICTIONARIES DS ON DS.DICTIONARIES_ID = I.CLASSTYPE_PKID AND DS.PARENT_ID = 'CLASSTYPE'
		WHERE I.PKID = #{pd.item_pkid} and SB.ZXZT='ZX'  and SB.ZHUANGTAI='1'
		and not exists 
		(select 1 from t_pay_item_list l where l.STUDENT_BM_PKID = SB.PKID AND L.T_PAY_ITEM_PKID = I.PKID)
		<if test="pd.seText!=null and pd.seText!=''">
			and ( S.SHENFENZHENGHAO LIKE CONCAT('%',CONCAT(#{pd.seText},'%'))
				OR S.XINGMING LIKE CONCAT('%',CONCAT(#{pd.seText},'%'))
				OR SB.XUEHAO LIKE CONCAT('%',CONCAT(#{pd.seText},'%'))) 
		</if>
	</select>
	<select id="getStuYouHuiInfo" parameterType="pd" resultType="pd">
		SELECT S.WHKXUEXIAO,TO_CHAR(SB.CJSJ,'YYYY-MM-DD HH24:MI:SS') BMSJ,SB.CENGCI_PKID,
		SB.LKFS,SB.BANJI,SB.XK_MARK  MEIYUAN,S.YJ_NIANFEN
		FROM T_STUDENT_BM SB
		JOIN T_STUDENT S ON S.PKID = SB.STUDENT_PKID
		WHERE SB.PKID = #{STUDENT_BM_PKID}
		AND ROWNUM = 1
	</select>
	<select id="getOnlyRuleCost" parameterType="pd" resultType="pd">
		SELECT * 
		FROM T_PAY_ITEM_RULE TP 
		WHERE TP.T_PAY_ITEM_PKID = #{T_PAY_ITEM_PKID}
        AND ROWNUM = 1
	</select>
	<select id="getRuleCost" parameterType="pd" resultType="pd">
		select 
		*
		from (
		    SELECT tp.* 
		    FROM T_PAY_ITEM_RULE TP 
		    left JOIN T_PAY_ITEM_RULE_FB RF ON TP.PKID = RF.T_PAY_ITEM_RULE_PKID
		    WHERE  TP.T_PAY_ITEM_PKID = #{T_PAY_ITEM_PKID} 
		        AND EXISTS 
		        (SELECT 1
		    FROM T_STUDENT_BM SB
		    JOIN T_STUDENT S ON S.PKID = SB.STUDENT_PKID
		    WHERE SB.PKID = #{STUDENT_BM_PKID}  
		    AND
		    (
		      (
		         S.WHKXUEXIAO IN 
		        (
		        select regexp_substr(RF.HZXY,'[^,]+', 1, level) from dual
		        connect by regexp_substr(RF.HZXY, '[^,]+', 1, level) is not null
		        ) 
		        AND TP.YOUHUI_TYPE = 1
		      )
		   OR  (
		        SB.CJSJ &gt;= RF.BAOMINGTIMEQ
		        AND  SB.CJSJ &lt;= RF.BAOMINGTIMEZ
		        AND TP.YOUHUI_TYPE = 2
		      )
		     OR  (SB.CENGCI_PKID IN 
		        (
		        select regexp_substr(RF.CENGCI,'[^,]+', 1, level) from dual
		        connect by regexp_substr(RF.CENGCI, '[^,]+', 1, level) is not null
		        )  
		      AND SB.LKFS &gt;= RF.ZUIDIFEN
		      AND SB.LKFS &lt;= RF.ZUIGAOFEN
		      AND TP.YOUHUI_TYPE = 4
		      )
		    OR (
		      SB.OLD_BANJI IS NOT NULL
		      AND SB.OLD_BANJI IN 
		        (
		        select regexp_substr(RF.T_CLASS_PKIDS,'[^,]+', 1, level) from dual
		        connect by regexp_substr(RF.T_CLASS_PKIDS, '[^,]+', 1, level) is not null
		        )
		      AND TP.YOUHUI_TYPE = 5
		      
		      )
		    OR (
		      S.YJ_NIANFEN IS NOT NULL
		      AND TP.YOUHUI_TYPE = 3
		      )
		    OR ( 
		      COMPAREABC(SB.XK_MARK,RF.SYS_MEI_DEPARTMENT_PKIDS) > 0  
		      and TP.YOUHUI_TYPE = 6
		      )
		    OR ( 
		      TP.YOUHUI_TYPE = 0
		      )
		    )
		    ) 
		    order by tp.zengjian_jine desc
		) tp 
		where rownum = 1
	</select>
	<insert id="saveAddItemList" parameterType="pd" useGeneratedKeys="false">
		 insert into t_pay_item_list
		  (pkid,
		   T_PAY_ITEM_PKID,
		   student_pkid,
		   cost,
		   discount,
		   amountreceivable,
		   DISCOUNT_MODE,
		   DISCOUNT_MONEY,
		   STUDENT_BM_PKID
		   )
		  select 
		  sys_guid(),
		  #{T_PAY_ITEM_PKID},
		  SB.STUDENT_PKID,
		  #{COST},
		  #{DISCOUNT},
		  #{AMOUNTRECEIVABLE},
		  #{DISCOUNT_MODE},
		  #{DISCOUNT_MONEY},
		  #{STUDENT_BM_PKID}
		  from T_STUDENT_BM SB
		  where pkid = #{STUDENT_BM_PKID}
	</insert>
	<!-- 其他项目列表 -->
	
	<select id="otherPayItemlistPage" parameterType="page" resultType="pd">

	 
 SELECT PKID,
        PAYITEM,
        CASE
          WHEN T.ITEM_TYPE = 1 THEN
           '自定义'
          WHEN T.ITEM_TYPE = 0 THEN
           '系统设置'
        END BGXLX,
        T.UPDATEPROFESSION,
        UPDATEPAYITEM,
        
        (SELECT USERNAME FROM SYS_USER U WHERE T.XGR = U.USER_ID) XGR,
        
        TO_CHAR(XGSJ, 'yyyy-MM-dd HH24:mi:ss') AS XGSJ
 
   FROM T_PAY_OTHER_ITEM T where 1=1 and status=1 
  ORDER BY T.ITEM_TYPE, XGSJ DESC

    </select>
    
    <!-- 修改其它缴费设置 -->
    <update id="updateotherpayitemset" parameterType="pd">
    	update T_PAY_OTHER_ITEM 
    	set 
    	XGSJ=SYSDATE
    	<if test="PAYITEM!=null and PAYITEM!=''">
    	,PAYITEM=#{PAYITEM}
    	</if>
    	<if test="UPDATEPROFESSION!=null and UPDATEPROFESSION!=''">
    	,UPDATEPROFESSION=#{UPDATEPROFESSION}
    	</if>
    	<if test="UPDATEPAYITEM!=null and UPDATEPAYITEM!=''">
    	,UPDATEPAYITEM=#{UPDATEPAYITEM}
    	</if>
    	<if test="XGR!=null and XGR!=''">
    	,XGR=#{XGR}
    	</if>
    	WHERE PKID=#{PKID}
    	
    	
    </update>
    
     <update id="updateitemlist" parameterType="pd">
    	update T_PAY_ITEM_LIST 
    	set 
    	XGSJ=SYSDATE
    	<if test="YINGSHOU!=null and YINGSHOU!=''">
    	,AMOUNTRECEIVABLE=#{YINGSHOU}
    	</if>
    	<if test="STATUS!=null and STATUS!=''">
    	,STATUS=#{STATUS}
    	</if>
    	WHERE PKID=#{LISTPKID}
    	
    	
    </update>
    
    
    <!--删除其它缴费项  -->
    
    <update id="deleteotherpayitemset" parameterType="pd">
    	UPDATE T_PAY_OTHER_ITEM SET STATUS=0 WHERE PKID=#{PKID}
    </update>
<!--end 其它缴费项目设置模块 sql -->
    
    
    
<!--begin 其他收费模块相关sql  -->
    
    <!--查询系统所有其它缴费项目  -->
    <select id="getOtherPayItems" resultType="pd">
    	select * from t_pay_other_item where status =1
    </select>
    
    <!-- 根据学生身份证号或学号查询学生基本信息-->
    <select id="getStuInfo" parameterType="pd" resultType="pd">
    	select t.XINGMING,t.shenfenzhenghao,t.xuehao,t.pkid,t.nianji,t.ZHUANYE,t.department_pkid,
    	(SELECT s.NAME FROM sys_dictionaries s WHERE s.BIANMA=t.zaixuezt) zxzt,
    	t.xiaoqu,
    	(select d.name from sys_department d where d.department_id=t.department_pkid) zuzhi
    	 from t_student T where 1=1 and zhuangtai=1 
    	<if test="SEARCHTEXT !=null and SEARCHTEXT!=''">
    		AND SHENFENZHENGHAO=#{SEARCHTEXT}
    		OR XUEHAO=#{SEARCHTEXT}
    	</if>
    </select>
    
    
    <!--查询当前高校下所有的项目  -->
    <select id="getPayItems" parameterType="pd" resultType="pd">
    	SELECT * FROM T_PAY_ITEM WHERE STATUS=1 
    	<!--AND COLLEGES_PKID=#{COLLEGES_PKID}  --> 
    </select>
    
    
    <!--查询某学生的某缴费项目的实际缴纳金额 -->
    <select id="getStuOrderMoney" parameterType="pd" resultType="pd">
    	SELECT NVL(T.MONEY,0) AS YIJIAOJINE  FROM T_PAY_ORDER_DETAIL T WHERE T.STUDENT_PKID=#{STUDENT_PKID} 
    	AND T.PAY_ITEM_PKID=#{PAY_ITEM_PKID}
    </select>
    
    <!--某个学生某个项目是否有优惠，有的话取出优惠方式和结果 -->
	<select id="getStuItemDiscountMoney" parameterType="pd"	resultType="pd">
		select pkid,discount_mode,
		(
		CASE
		WHEN discount_mode=0
		THEN '不优惠'
		WHEN discount_mode=1
		THEN '打折'
		ELSE
		'直减'
		END
		)yhfs,
		(
		CASE
		WHEN discount_mode=0
		THEN 0
		WHEN discount_mode=1
		THEN discount
		ELSE
		discount_money
		END
		)yh
		from t_pay_item_rule where instr(PROFESSION, #{PROFESSION}) &gt; 0 AND
		INSTR(GRADE,#{GRADE})&gt;0 AND pay_item_pkid=#{PAY_ITEM_PKID} AND instr(DISCOUNT_SCOPE, #{DISCOUNT_SCOPE}) > 0


	</select>
    
    <!--查询某学生可以转出的缴费项目 t_pay_item_list中查询  -->
    <select id="getStuCanOutPayitems" parameterType="pd" resultType="pd">
    		SELECT A.AMOUNTCOLLECTION,a.amountreceivable,a.discount,B.PKID,B.PAYITEM FROM T_PAY_ITEM_LIST A JOIN T_PAY_ITEM B ON A.PAY_ITEM_PKID=B.PKID

            WHERE STUDENT_PKID=#{STUDENT_PKID} and A.AMOUNTCOLLECTION &gt;0
            
            <if test="list!=null and list.size()>0">
            AND PAY_ITEM_PKID NOT IN 
            <foreach collection="list" item="PAY_ITEM_PKID" open="(" separator="," close=")">
					#{PAY_ITEM_PKID}
			</foreach>
            </if>
    </select>
    <!--可以转入的项目  -->
	<select id="getStuCanInPayitems" parameterType="pd" resultType="pd">
		SELECT T.PAY_ITEM_PKID AS PKID,
		(SELECT i.payitem FROM t_pay_item i WHERE t.pay_item_pkid=i.pkid) payitem 
		FROM T_PAY_ITEM_LIST T
		
		left join t_student stu on t.student_pkid = stu.pkid 
		
		WHERE 1=1 and T.STUDENT_PKID = #{STUDENT_PKID} 
		and exists (select 1 from T_PAY_ITEM I WHERE I.PKID = T.PAY_ITEM_PKID AND I.STATUS IN (1,2))
		<!-- 如果是调整专业，需过滤原专业项目 -->
		<if test="changeprofess!=null and changeprofess !='' ">
			and stu.nianji !=#{nianji}
			and stu.department_pkid !=#{department_pkid}
		</if>
		<if test="list!=null and list.size()>0">
		AND t.pay_item_pkid NOT IN 
		     <foreach collection="list" item="PAY_ITEM_PKID" open="(" separator="," close=")">
						#{PAY_ITEM_PKID}
		     </foreach>
		</if>
		<!-- AND T.AMOUNTCOLLECTION>0 -->
		<!-- 先加上实付小于应缴 -->
		and   T.AMOUNTCOLLECTION &lt;T.AMOUNTRECEIVABLE
		
		UNION
		SELECT A.PKID,
		payitem
		FROM T_PAY_ITEM A

		JOIN T_PAY_ITEM_RULE B ON A.PKID = B.PAY_ITEM_PKID
		AND A.STATUS = 1
		<if test="list!=null and list.size()>0">
		 AND A.pkid NOT IN 
		      <foreach collection="list" item="PAY_ITEM_PKID" open="(" separator="," close=")">
						#{PAY_ITEM_PKID}
		      </foreach>
		 </if>
		 
		AND A.STARTUSING = 'Y'
		AND INSTR(B.PROFESSION,
		#{PROFESSION}) > 0
		AND INSTR(B.GRADE, #{GRADE}) > 0
		AND A.STARTDATE IS NOT NULL 
		AND SYSDATE > A.STARTDATE
		AND SYSDATE &lt; A.ENDDATE
		
		UNION
		SELECT A.PKID,
		payitem
		FROM T_PAY_ITEM A

		JOIN T_PAY_ITEM_RULE B ON A.PKID = B.PAY_ITEM_PKID
		AND A.STATUS = 1
		<if test="list!=null and list.size()>0">
		 AND A.pkid NOT IN 
		      <foreach collection="list" item="PAY_ITEM_PKID" open="(" separator="," close=")">
						#{PAY_ITEM_PKID}
		      </foreach>
		 </if>
		 
		AND A.STARTUSING = 'Y'
		AND INSTR(B.PROFESSION,
		#{PROFESSION}) > 0
		AND INSTR(B.GRADE, #{GRADE}) > 0
		AND  A.STARTDATE IS NULL


	</select>
    <!-- 查询项目各种金额 -->
    <select id="getpayItemMoneyByList" parameterType="pd" resultType="pd">
    SELECT T.PAY_ITEM_PKID AS PKID,T.AMOUNTCOLLECTION,T.PAY_ITEM_RULE,
		T.COST,
		 (CASE 
       WHEN T.DISCOUNT_MODE=0
       THEN '不优惠'
        WHEN T.DISCOUNT_MODE=1
       THEN T.discount
        WHEN T.DISCOUNT_MODE=2
       THEN concat('直减',T.DISCOUNT_MONEY)
       END)YHFS,T.DISCOUNT_MODE,
		T.DISCOUNT_MONEY,
		(T.AMOUNTRECEIVABLE - T.AMOUNTCOLLECTION) SYYJJE,
		(SELECT i.payitem FROM t_pay_item i WHERE t.pay_item_pkid=i.pkid) payitem,
		T.pay_item_rule as pay_item_rule_pkid
		FROM T_PAY_ITEM_LIST T
		WHERE 1=1 and T.STUDENT_PKID = #{STUDENT_PKID}
		<if test="PAY_ITEM_PKID!=null and PAY_ITEM_PKID !=''">
		AND t.pay_item_pkid =#{PAY_ITEM_PKID}
		</if>
    </select>
    <!-- 查询项目的各种金额 2-->
    <select id="getPayItemMoneyByRule" parameterType="pd" resultType="pd">
    SELECT w.*,(w.cost-w.discount_money)syyjje FROM (
    SELECT A.PKID,
       A.COST,
       (CASE 
       WHEN B.DISCOUNT_MODE=0
       THEN '不优惠'
        WHEN B.DISCOUNT_MODE=1
       THEN concat(concat('打',b.discount),'折')
        WHEN B.DISCOUNT_MODE=2
       THEN concat('直减',B.DISCOUNT_MONEY)
       END)YHFS,B.DISCOUNT_MODE,
      
       (CASE
         WHEN (SELECT COUNT(*)
                 FROM (SELECT REGEXP_SUBSTR((SELECT R.DISCOUNT_SCOPE
                                              FROM T_PAY_ITEM_RULE R
                                             WHERE INSTR(R.PROFESSION,
                                                         #{PROFESSION}) > 0
                                               AND INSTR(R.GRADE,
                                                         #{GRADE}) > 0 AND r.pay_item_pkid=#{PAY_ITEM_PKID}  ),
                                            '[^,]+',
                                            1,
                                            LEVEL) EXCEPTIONAL
                         FROM DUAL
                       CONNECT BY REGEXP_SUBSTR((SELECT R.DISCOUNT_SCOPE
                                                  FROM T_PAY_ITEM_RULE R
                                                 WHERE INSTR(R.PROFESSION,
                                                             #{PROFESSION}) > 0
                                                   AND INSTR(R.GRADE,
                                                             #{GRADE}) > 0 AND r.pay_item_pkid=#{PAY_ITEM_PKID}  ),
                                                '[^,]+',
                                                1,
                                                LEVEL) IS NOT NULL 
                       INTERSECT
                       SELECT EXCEPTIONAL
                         FROM T_STUDENT_FLAG
                        WHERE STUDENT_PKID =
                              #{STUDENT_PKID}) WHERE EXCEPTIONAL IS NOT NULL  ) > 0
         
          THEN
          (
              CASE 
              WHEN B.DISCOUNT_MODE=1
              THEN round(a.cost*0.1*( 10-b.discount),2)
              WHEN b.DISCOUNT_MODE=2
              THEN nvl(B.DISCOUNT_MONEY,0)
              END 
           )
         ELSE
          0
       END) as  discount_money,
       A.payitem,B.pkid as pay_item_rule_pkid 
  FROM T_PAY_ITEM A

 JOIN T_PAY_ITEM_RULE B ON A.PKID = B.PAY_ITEM_PKID AND a.pkid=#{PAY_ITEM_PKID} 
 <if test="PAY_ITEM_RULE!=null and PAY_ITEM_RULE !=''">
 	and b.PKID!=#{PAY_ITEM_RULE}
 </if>
    ) w where rownum=1
    </select>
    
    
    <!-- LIST列表 -->
	<select id="datalistPage" parameterType="page" resultType="pd">
		SELECT T.PAY_ORDER_PKID,t.input_output,
		(CASE
		WHEN T.STATUS = 1 THEN
		'正常'
		WHEN T.STATUS = 2 THEN
		'转入'
		WHEN T.STATUS = 3 THEN
		'转出'
		END) ZHUANGTAI,to_char(T.CJSJ,'yyyy-MM-dd HH24:mi:ss') CJSJ,
		T.MONEY,
    otherpayitem,
		D.*
    
		FROM T_PAY_ORDER_DETAIL T JOIN (
     SELECT o.*,(SELECT payitem FROM t_pay_other_item po WHERE po.pkid=o.other_item ) otherpayitem FROM  t_pay_order o WHERE o.ordercreate_mode='DO') r ON t.pay_order_pkid=r.pkid
		LEFT JOIN
		(SELECT PAY_ORDER_DETAIL_PKID,
		MAX(DECODE(PAY_MODE, 'CASH', MONEY, 0)) AS CASH,
		MAX(DECODE(PAY_MODE, 'CARD', MONEY, 0)) AS CARD,
		MAX(DECODE(PAY_MODE, 'ZFB', MONEY, 0)) AS ZFB,
		MAX(DECODE(PAY_MODE, 'WX', MONEY, 0)) AS WX
		FROM T_PAY_ORDER_DETAIL_MONEY
    
		GROUP BY PAY_ORDER_DETAIL_PKID) D ON T.PKID = D.PAY_ORDER_DETAIL_PKID
		WHERE <!-- T.OTHERITEM_FLAG = 'Y' --> 1=1
		AND T.STUDENT_PKID = #{pd.STUDENT_PKID}
        <if test="pd.PAY_ITEM_PKID!=null and pd.PAY_ITEM_PKID!=''">
        and other_item=#{pd.PAY_ITEM_PKID}
        </if>
        ORDER BY T.CJSJ DESC 
	</select>
    
    
    
    
<!--end 其他收费模块相关sql  -->

	<!-- 缴费项目列表 -->
	
	<select id="getPayItemlistPage" parameterType="page" resultType="pd">


	SELECT t.pkid,t.PAY_TYPE_PKID,t.GRADE_PKID,t.CLASSTYPE_PKID,t.STARTUSING,
(select l.pay_style_name  from t_pay_style l where l.pkid=t.PAY_TYPE_PKID) STYLE_NAME,
(select NAME from sys_dictionaries s where s.parent_id='GRADE'  and s.dictionaries_id=t.GRADE_PKID ) GRADE_NAME,
(select NAME from sys_dictionaries s where s.parent_id='CLASSTYPE'  and s.dictionaries_id=t.CLASSTYPE_PKID) CLASSTYPE_NAME,
t.ITEMLIST_CREATEMODE JFMDFS,
  CASE
  WHEN t.ITEMLIST_CREATEMODE=1 THEN '导入缴费名单'
  WHEN t.ITEMLIST_CREATEMODE=2 THEN '系统根据规则生成'
  END ITEMLIST_CREATEMODE
  FROM T_PAY_ITEM t
  WHERE 1=1 
  <if test="pd.PAY_TYPE_PKID !=null and pd.PAY_TYPE_PKID!=''">
   		AND t.PAY_TYPE_PKID=#{pd.PAY_TYPE_PKID}
   	</if>
   	<if test="pd.GRADE_PKID !=null and pd.GRADE_PKID!=''">
   		AND t.GRADE_PKID=#{pd.GRADE_PKID}
   	</if>
   	<if test="pd.CLASSTYPE_PKID !=null and pd.CLASSTYPE_PKID!=''">
   		AND t.CLASSTYPE_PKID = #{pd.CLASSTYPE_PKID}
   	</if>
	ORDER BY t.CJSJ DESC 






	<!-- SELECT PKID,PAYITEM,COST,
	
	CASE
	WHEN t.ITEMLIST_CREATEMODE=1 THEN '导入缴费名单'
	WHEN t.ITEMLIST_CREATEMODE=2 THEN '系统根据规则生成'
	END ITEMLIST_CREATEMODE,

	ENDDATE,
	
	CASE
	WHEN t.MUSTPAY='Y' THEN '是'
	WHEN t.MUSTPAY='N' THEN '否'
	END MUSTPAY,
	
	CASE
	WHEN t.STATUS=0 THEN '待审核'
	WHEN t.STATUS=1 THEN '审核成功'
	WHEN t.STATUS=-1 THEN '审核失败'
	WHEN t.STATUS=2 THEN '已结束'
	WHEN t.STATUS=3 THEN '已过期'
	END STATUS,
	t.STATUS as STATUSNO,
	STARTUSING,
	to_char(XGSJ,'yyyy-MM-dd HH24:mi:ss') as XGSJ,
	to_char(t.STARTDATE,'yyyy-MM-dd HH24:mi:ss') STARTD,
	to_char(t.ENDDATE,'yyyy-MM-dd HH24:mi:ss') ENDD, 
    to_char(STARTDATE,'yyyy-MM-dd HH24:mi:ss')||'-'||to_char(ENDDATE,'yyyy-MM-dd HH24:mi:ss')  INTERVAL_DATE
	FROM T_PAY_ITEM t
	WHERE 1=1 
	<if test="pd.startusing !=null and pd.startusing!=''">
   		AND t.STARTUSING=#{pd.startusing}
   	</if>
   	<if test="pd.status !=null and pd.status!=''">
   		AND t.STATUS=#{pd.status}
   	</if>
   	<if test="pd.payitem !=null and pd.payitem!=''">
   		AND t.PAYITEM LIKE CONCAT(CONCAT('%', #{pd.payitem}),'%')
   	</if>
   	<if test="pd.startDate !=null and pd.startDate!=''">
   		<![CDATA[ AND t.CJSJ >=to_date(#{pd.startdate},'yyyy-mm-dd HH24:mi:ss') ]]>   
   		and to_char(t.CJSJ,'yyyy-mm-dd') &gt;=#{pd.startDate}
   	</if>
   	<if test="pd.endDate !=null and pd.endDate !=''">
   		and to_char(t.CJSJ,'yyyy-mm-dd') &lt;=#{pd.endDate}
   		<![CDATA[ AND t.CJSJ <= to_date(#{pd.enddate},'yyyy-mm-dd HH24:mi:ss') ]]>
   	</if>
   	

	ORDER BY t.CJSJ DESC  -->
    </select>
    
    <!-- 修改缴费设置 -->
    <update id="updatePayItem" parameterType="pd">
    	update T_PAY_ITEM 
    	set 
    	XGSJ=SYSDATE
    	<if test="startusing!=null and startusing!=''">
    	,STARTUSING=#{startusing}
    	</if>
    	WHERE PKID=#{PKID}
    	
    </update>
    
    <!-- 缴费名单列表  edit by kangcl-->
	
	<select id="getPayItemListlistPage" parameterType="page" resultType="pd">
	
select t.PKID,u.shenfenzhenghao,s.XUEHAO,u.xingming,S.RXNIANFEN_PKID,S.BANJI_TYPE_PKID,
(select name from SYS_DICTIONARIES D where d.PARENT_ID = 'GRADE' AND D.DICTIONARIES_ID=i.grade_pkid) RUXUENIANFEN,
(select name from SYS_DICTIONARIES D where d.PARENT_ID = 'CLASSTYPE' AND D.DICTIONARIES_ID=i.classtype_pkid) BANXING,
S.BANJI,
(select CLASS_NAME from T_CLASS S WHERE S.PKID=S.BANJI) CLASS_NAME,
      (case when t.status = '0' then '欠费' when t.status = '1' then '核验中' when t.status = '2' then '已完成' when t.status = '3' then '已关闭' end) ztstatus,
       sy.pay_style_name,
      t.status,
       nvl(t.AMOUNTRECEIVABLE,'0')AMOUNTRECEIVABLE, nvl(t.AMOUNTCOLLECTION,'0')AMOUNTCOLLECTION
      from T_PAY_ITEM_LIST t
      join T_PAY_ITEM i on i.PKID=T.T_PAY_ITEM_PKID
      join t_pay_style sy on i.pay_type_pkid=sy.pkid
       join t_Student_Bm s on t.STUDENT_BM_PKID = s.PKID
       join t_student u on u.pkid=s.student_pkid
      where 1=1  and s.ZHUANGTAI='1' and s.ZXZT='ZX' and s.IS_TONGGUO!=0 AND T.T_PAY_ITEM_PKID=#{pd.payItemPkid} 
      <if test="pd.RXNIANFEN_PKID!=null and pd.RXNIANFEN_PKID!=''">
		and i.grade_pkid = #{pd.RXNIANFEN_PKID} 
		</if>
    
    <if test="pd.BANJI_TYPE_PKID!=null and pd.BANJI_TYPE_PKID!=''">
		and i.classtype_pkid = #{pd.BANJI_TYPE_PKID} 
		</if>
     <if test="pd.STATUS!=null and pd.STATUS!=''">
		and T.STATUS = #{pd.STATUS} 
		</if>
   <if test="pd.conditions!=null and pd.conditions!=''">
	   		and (
	   		s.XUEHAO LIKE CONCAT(CONCAT('%', #{pd.conditions}),'%')
	   		or u.SHENFENZHENGHAO LIKE CONCAT(CONCAT('%', #{pd.conditions}),'%') 
	   		or u.XINGMING LIKE CONCAT(CONCAT('%', #{pd.conditions}),'%') 
	   		)
	   	</if>
	ORDER BY t.XGSJ DESC 
	
	
	
	
	
	
	
	
	
	
	
	
	<!-- 	select t.PKID,
		i.PAYITEM,
	  	p.pici_name,
	  	c.cengci_name,
	  	s.nianji,
	  	(case when t.status = '0' then '欠费' when t.status = '1' then '核验中' when t.status = '2' then '已完成' when t.status = '3' then '已关闭' end) status,
	  	t.PAY_ITEM_PKID,t.COST,t.DISCOUNT,t.AMOUNTRECEIVABLE,t.AMOUNTCOLLECTION, s.PKID SPKID,s.SHENFENZHENGHAO,s.XINGMING,s.DEPARTMENT_PKID,
	  	departmentstr(s.department_pkid) ZUZHINAME 
	  	from T_PAY_ITEM_LIST t
	  	join T_PAY_ITEM i on i.PKID=T.PAY_ITEM_PKID and i.status in (1,2)
	  	left join T_STUDENT s on t.student_pkid = s.pkid
	  	left join t_pici p on p.pkid = s.pici_pkid
	  	left join t_cengci c on c.pkid = s.cengci_pkid
	  	where 1=1 and s.ZAIXUEZT='ZX' 
		<if test="pd.payItemPkid!=null and pd.payItemPkid!=''">
		and t.PAY_ITEM_PKID = #{pd.payItemPkid} 
		</if>
		<if test="pd.status!=null and pd.status!=''">
	   		and t.status=#{pd.status}
	   	</if>
	   	<if test="pd.grade!=null and pd.grade!=''">
	   		and s.NIANJI=#{pd.grade}
	   	</if>
	   	<if test="pd.DEPARTMENT_PKID!=null and pd.DEPARTMENT_PKID!=''">
	   		and s.DEPARTMENT_PKID=#{pd.DEPARTMENT_PKID}
	   	</if>
	   	<if test="pd.departmentPkids!=null">
			AND s.DEPARTMENT_PKID IN 
			<foreach item="item" index="index" collection="pd.departmentPkids" open="(" separator="," close=")"> 
			   #{pd.departmentPkids[${index}]} 
			  </foreach>
	    </if>
	   	<if test="pd.conditions!=null and pd.conditions!=''">
	   		and (
	   		s.XUEHAO LIKE CONCAT(CONCAT('%', #{pd.conditions}),'%')
	   		or s.SHENFENZHENGHAO LIKE CONCAT(CONCAT('%', #{pd.conditions}),'%') 
	   		or s.XINGMING LIKE CONCAT(CONCAT('%', #{pd.conditions}),'%') 
	   		)
	   	</if> -->
		
    </select>
    
    <!-- 修改缴费名单 -->
    <update id="updatePayItemList" parameterType="pd">
    	update T_PAY_ITEM_LIST
    	set 
    	XGSJ=SYSDATE
    	<if test="cost!=null and cost!=''">
    		,COST=#{cost}
    	</if>
    	<if test="amountreceivable!=null and amountreceivable!=''">
    		,AMOUNTRECEIVABLE=#{amountreceivable}
    	</if>
    	<if test="discountMode!=null and discountMode!=''">
    		,DISCOUNT_MODE=#{discountMode}
    	</if>
    	<if test="discount!=null and discount!=''">
    		,DISCOUNT=#{discount}
    	</if>
    	<if test="discountMoney!=null and discountMoney!=''">
    		,DISCOUNT_MONEY=#{discountMoney}
    	</if>
    	WHERE PKID=#{pkid}
    	
    </update>
    
    <!-- 修改缴费名单 -->
    <update id="updatePayItemListDiscount" parameterType="pd">
    	update T_PAY_ITEM_LIST_DISCOUNT
    	set 
    	XGSJ=SYSDATE,ALONEFLAG='Y' 
    	<if test="discount_money!=null and discount_money!=''">
    		,DISCOUNT_MONEY=#{discountMoney}
    	</if>
    	<if test="discountMode!=null and discountMode!=''">
    		,DISCOUNT_MODE=#{discountMode}
    	</if>
    	<if test="discount!=null and discount!=''">
    		,DISCOUNT=#{discount}
    	</if>
    	WHERE PAY_ITEM_LIST_PKID=#{payItemListPkid}
    	
    </update>
    
    <!-- 根据id获得对象-->
    <select id="getPayItemListInfo" parameterType="pd" resultType="pd">
    	select COST,DISCOUNT,AMOUNTRECEIVABLE from T_PAY_ITEM_LIST 
    	where 1=1 
    	and PKID=#{PKID}
    </select>
    
    <!--删除缴费项  -->
    <delete id="deletePayItem" parameterType="pd">
    	DELETE FROM T_PAY_ITEM WHERE PKID=#{PKID}
    </delete>
    
    <!-- 保存项目发布 T_PAY_ITEM表数据 -->
	<insert id="saveItem" parameterType="pd">
	  insert into t_pay_item
	  (PKID, PAY_TYPE_PKID, GRADE_PKID, CLASSTYPE_PKID,ITEMLIST_CREATEMODE,CJR)
		values
	  (#{ITEMPKID},#{PAY_TYPE_PKID},#{GRADE_PKID},#{CLASSTYPE_PKID},#{ITEMLIST_CREATEMODE},#{CJR})
	</insert>
	
	
	
	
	 <!-- 保存项目发布导入方式  T_PAY_ITEM_list表数据 -->
	<insert id="saveItemList" parameterType="pd">
  insert into t_pay_item_list
  (pkid,
   T_PAY_ITEM_PKID,
   student_pkid,
   cost,
   discount,
   amountreceivable,
   discount_money
   )
values
  (
   #{IPKID},
   #{PAY_ITEM_PKID},
   #{STUDENT_PKID},
   #{COST},
   #{DISCOUNT},
   #{AMOUNTRECEIVABLE},
   #{DISCOUNT_MONEY}
)
	</insert>
	<!-- 保存项目发布导入方式  T_PAY_ITEM_list表数据 -->
	<insert id="saveItemListdr" parameterType="pd">
	  insert into t_pay_item_list
	  (pkid,
	   T_PAY_ITEM_PKID,
	   student_pkid,
	   STUDENT_BM_PKID,
	   cost,
	   discount,
	   amountreceivable,
	   discount_money,
	   DISCOUNT_MODE
	   )
		values
	  (
	   #{IPKID},
	   #{PAY_ITEM_PKID},
	   #{STUDENT_PKID},
	   #{STUDENT_BM_PKID},
	   #{COST},
	   #{DISCOUNT},
	   #{AMOUNTRECEIVABLE},
	   #{DISCOUNT_MONEY},
	   #{DISCOUNT_MODE}
	  )
	</insert>
	<!-- 保存项目发布 RULE表数据 -->
	<insert id="saveRule" parameterType="pd">
	  insert into t_pay_item_rule
	  (pkid,cost, youhui_type, zengjian_type, zengjian_jine, t_pay_item_pkid)
		values
	  (#{RULEPKID},#{COST},#{YOUHUI_TYPE},#{ZENGJIAN_TYPE},#{ZENGJIAN_JINE},#{T_PAY_ITEM_PKID})
	</insert>
	<insert id="saveRuleFb" parameterType="pd">
		insert into t_pay_item_rule_fb
		(pkid, t_pay_item_rule_pkid, hzxy, baomingtimeq, baomingtimez, cengci, zuigaofen, zuidifen, t_class_pkids, sys_mei_department_pkids)
		values 
		(#{RULEFBPKID},#{T_PAY_ITEM_RULE_PKID},#{HZXY,jdbcType=VARCHAR},to_date(#{BAOMINGTIMEQ,jdbcType=DATE},'YYYY-MM-DD HH24:MI:SS'),to_date(#{BAOMINGTIMEZ,jdbcType=DATE},'YYYY-MM-DD HH24:MI:SS'),#{CENGCI,jdbcType=VARCHAR},#{ZUIGAOFEN,jdbcType=NUMERIC},
		#{ZUIDIFEN,jdbcType=NUMERIC},#{T_CLASS_PKIDS,jdbcType=VARCHAR},
		#{SYS_MEI_DEPARTMENT_PKIDS,jdbcType=VARCHAR})
	</insert>
	<select id="indefyItem" parameterType="pd" resultType="pd">
		select * from T_PAY_ITEM i where i.PAY_TYPE_PKID = #{PAY_TYPE_PKID}
		and i.GRADE_PKID = #{GRADE_PKID} and i.CLASSTYPE_PKID = #{CLASSTYPE_PKID}
		and rownum = 1
	</select>

	
	 <!-- 得到学生pkid -->
    <select id="getxspkidlist" parameterType="pd" resultType="pd">
select s.PKID from t_student s where  s.department_pkid in 
(
select regexp_substr(#{orgtreeid},'[^,]+', 1, level) from dual
connect by regexp_substr(#{orgtreeid}, '[^,]+', 1, level) is not null
) and s.nianji in
(
select regexp_substr(#{nianjilist},'[^,]+', 1, level) from dual
connect by regexp_substr(#{nianjilist}, '[^,]+', 1, level) is not null
) 
AND s.CENGCI_PKID IN
(
	select regexp_substr(#{cengcilist},'[^,]+', 1, level) from dual
	connect by regexp_substr(#{cengcilist}, '[^,]+', 1, level) is not null
)
AND s.PICI_PKID IN
(
	select regexp_substr(#{picilist},'[^,]+', 1, level) from dual
	connect by regexp_substr(#{picilist}, '[^,]+', 1, level) is not null
)
and s.ZHUANGTAI=1
	</select>
	
		 <!-- 得到学生flag -->
    <select id="getxsflaglist" parameterType="pd" resultType="pd">
	select t.exceptional from t_student_flag t where t.student_pkid=#{XSPKID}
	</select>
	
	 <select id="getxsyhlist" parameterType="pd" resultType="pd">
	select * from t_pay_item_rule r where r.pkid =(select l.PAY_ITEM_RULE from t_pay_item_list l where l.pkid=#{LISTPKID}) 
	 <if test="FLAG!=null and FLAG!=''">
		 and #{FLAG}  in (
		 select regexp_substr(r.DISCOUNT_SCOPE,'[^,]+', 1, level) from dual
		connect by regexp_substr(r.DISCOUNT_SCOPE, '[^,]+', 1, level) is not null
		 )
	   </if>
	
	</select>
	
	
	
	<!-- 更新t_pay_item_list -->
    <update id="updateList" parameterType="pd">
    	update t_pay_item_list 
    	set 
    	<if test="DC!=null and DC!=''">
    	DISCOUNT=#{DC}
    	</if>
    	<if test="ysje!=null and ysje!=''">
    	,AMOUNTRECEIVABLE=#{ysje}
    	</if>
    	<if test="DMONEY!=null and DMONEY!=''">
    	,DISCOUNT_MONEY=#{DMONEY}
    	</if>
    	<if test="yhlx!=null and yhlx!=''">
    	,DISCOUNT_MODE=#{yhlx}
    	</if>
    	WHERE PKID=#{LISTPKID}
    	
    </update>
	
	
	
	<insert id="saveItemLlstxs" parameterType="pd">
	  insert into t_pay_item_list
	  (pkid,T_PAY_ITEM_PKID,student_pkid,cost,pay_item_rule)
	  VALUES(#{LISTPKID},#{ITEMPKID},#{XSPKID},#{JE},#{RULEPKID})
 	</insert>
	
	
	
	
    <!-- 得到年级 -->
    <select id="getnianji" parameterType="pd" resultType="pd">
		select * from sys_dictionaries t where t.parent_id='GRADE' 
	</select>
	
	 <!-- 得到banxing -->
    <select id="getbanxing" parameterType="pd" resultType="pd">
		select * from sys_dictionaries t where t.parent_id='CLASSTYPE' 
	</select>
	<!-- 得到优惠范围 -->
    <select id="getyouhuifw" parameterType="pd" resultType="pd">
		select * from sys_dictionaries t where t.parent_id='STUDENT_FLAG'
	</select>
	<!--树结构  查询所有的学院节点  -->
	<select id="getZuzhis" resultType="pd" parameterType="pd">
	   select z.department_id, z.name || '(' || Z.rs || '人)' name, z.parent_id
     from (select t.name,
                  t.department_id,
                  t.parent_id,
                  (select sum(son.rs)
                     from v_sys_department son
                    start with son.DEPARTMENT_ID = t.department_id
                   connect by prior son.DEPARTMENT_ID = son.PARENT_ID) rs
             from v_sys_department t) z
	</select>
	
	<!-- 缴费审核列表 -->
	
	<select id="jfshenhelistPage" parameterType="page" resultType="pd">
  select a.* 
          from (select i.pkid,
                       i.cjsj,
                       i.payitem,
                       i.STATUS,
                       i.ITEMLIST_CREATEMODE,
                       nvl(i.cost,0) cost,
                       to_char(i.startdate, 'YYYY-MM-DD hh24:mi:ss') || '-' ||
                       to_char(i.enddate, 'YYYY-MM-DD hh24:mi:ss') YXQ,
                       (case
                         when i.mustpay = 'Y' then
                          '是'
                         when i.mustpay = 'N' then
                          '否'
                       end) bxjf,
                       (case
                         when i.STATUS = '0' then
                          '待审核'
                         when i.STATUS = '1' then
                          '审核成功'
                         when i.STATUS = '-1' then
                          '审核失败'
                         when i.STATUS = '2' then
                          '已结束'
                         when i.STATUS = '3' then
                          '已过期'
                       end) zt,
                       (select count(l.pay_item_pkid)
                          from t_pay_item_list l
                         where i.pkid = l.pay_item_pkid and exists (select 1 from t_student s where s.PKID = l.STUDENT_PKID and s.ZAIXUEZT = 'ZX')) rs,
                       ((select count(l.pay_item_pkid)
                           from t_pay_item_list l
                          where i.pkid = l.pay_item_pkid
                          and exists (select 1 from t_student s where s.PKID = l.STUDENT_PKID and s.ZAIXUEZT = 'ZX')
                          ) * i.cost) zje,
                       (select count(*)
                          from t_pay_item_list s
                         where s.pay_item_pkid = i.pkid and nvl(s.DISCOUNT_MONEY,0)>0
                           and s.discount_mode != 0
                           and exists (select 1 from t_student s where s.PKID = S.STUDENT_PKID and s.ZAIXUEZT = 'ZX')
                           ) yhrs,
                          nvl((select  sum(DISCOUNT_MONEY) from t_pay_item_list l where l.pay_item_pkid=i.pkid  and l.discount_mode != 0
                          and exists (select 1 from t_student s where s.PKID = l.STUDENT_PKID and s.ZAIXUEZT = 'ZX')
                          ),0) yhje,
                          (select  sum(AMOUNTRECEIVABLE) from t_pay_item_list l where l.pay_item_pkid=i.pkid  
                          and exists (select 1 from t_student s where s.PKID = l.STUDENT_PKID and s.ZAIXUEZT = 'ZX')
                          ) yszje
                  from t_pay_item i) a where 1=1 
                  <if test="pd.RQQ!=null and pd.RQQ!=''">
    				and to_char(a.cjsj,'yyyy-mm-dd') &gt;=#{pd.RQQ}
    			  </if>
    			  <if test="pd.RQZ!=null and pd.RQZ!=''">
    				and to_char(a.cjsj,'yyyy-mm-dd') &lt;=#{pd.RQZ}
    			  </if>
    			   <if test="pd.XMMC!=null and pd.XMMC!=''">
    				 and a.payitem LIKE CONCAT(CONCAT('%', #{pd.XMMC}),'%')
    			  </if>
    			   <if test="pd.STATUS!=null and pd.STATUS!=''">
    				and  a.STATUS =#{pd.STATUS}
    			  </if>
                  
                  order by cjsj desc

    </select>
	<update id="updatebatchGree" parameterType="String">
	update
		t_pay_item 
		set STATUS=1 ,XGSJ=SYSDATE
		where 
			PKID  in
		<foreach item="item" index="index" collection="array" open="(" separator="," close=")">
                 #{item}
		</foreach>
    </update>
    
    <update id="updatebatchGreeOne" parameterType="String">
	update
		t_pay_item 
		set STATUS=1 ,XGSJ=SYSDATE
		where PKID  =#{PKID}
    </update>
    <update id="updatebatchNoOne" parameterType="String">
	update
		t_pay_item 
		set STATUS= -1 ,XGSJ=SYSDATE
		where 
			PKID  =#{PKID}
		
    </update>
    
    <update id="updatebatchNo" parameterType="String">
	update
		t_pay_item 
		set STATUS= -1 ,XGSJ=SYSDATE
		where 
			PKID  in
		<foreach item="item" index="index" collection="array" open="(" separator="," close=")">
                 #{item}
		</foreach>
    </update>
    
    <select id="getItem" parameterType="pd" resultType="pd">
  		select * from t_pay_item where pkid=#{PKID}
    </select>
    
    
    <select id="rulelist" parameterType="pd" resultType="pd">
    	select * from T_PAY_ITEM_RULE where T_PAY_ITEM_PKID = #{PKID}
    </select>
    <select id="getRuleFB" parameterType="pd" resultType="pd">
    	select  pkid, t_pay_item_rule_pkid, hzxy, 
    	to_char(baomingtimeq,'YYYY-MM-DD') baomingtimeq,
    	to_char(baomingtimez,'YYYY-MM-DD') baomingtimez, cengci, zuigaofen, zuidifen, t_class_pkids, sys_mei_department_pkids
    	from T_PAY_ITEM_RULE_FB rb
    	 
    	where rb.T_PAY_ITEM_RULE_PKID = #{PKID}
    </select>
    <select id="getHzxyName" parameterType="pd" resultType="pd">
    	select * from T_PART_SCHOOL where pkid = #{PKID}
    </select>
     <select id="getlistrule" parameterType="pd" resultType="pd">
     select * from t_pay_item_rule r  where r.pay_item_pkid = #{PKID}
    </select>

    <!--查询缴费项目  -->
    <select id="getPayItemListByPayItemPkid"  parameterType="pd" resultType="pd">
    	select * from t_pay_item_list t where t.T_PAY_ITEM_PKID = #{payItemPkid}
    </select>
    <!-- 通过学生查找学生的缴费项目列表 -->
	
	<select id="getPayItemlistPageByStudentPkidAndStatus" parameterType="page" resultType="pd">

		   SELECT T1.AMOUNTRECEIVABLE,T1.AMOUNTCOLLECTION,T1.PKID,T1.T_PAY_ITEM_PKID,T1.T_PAY_ITEM_PKID PAY_ITEM_PKID,T2.ITEMLIST_CREATEMODE,
		   T1.STUDENT_BM_PKID,T3.PAY_STYLE_NAME,T3.PAY_STYLE_BIANMA,T4.RXNIANFEN_PKID,T4.BANJI_TYPE_PKID,
           (SELECT D.NAME FROM sys_dictionaries D WHERE D.DICTIONARIES_ID = T2.GRADE_PKID) RXNIANFEN, 
           (SELECT D.NAME FROM sys_dictionaries D WHERE D.DICTIONARIES_ID = T2.CLASSTYPE_PKID) BANJI_TYPE,
	       T1.STATUS,T5.WHKXUEXIAO,T4.CENGCI_PKID,T4.LKFS,T4.OLD_BANJI,T4.XK_MARK,(select count(*)  from T_PAY_ITEM_RULE u where u.t_pay_item_pkid=T2.PKID and u.YOUHUI_TYPE!=0) EXISE,
	       (select count(*)  from t_pay_item_list_changelog g where g.t_pay_item_list_pkid=T1.PKID ) LOGEXISE
	       FROM T_PAY_ITEM_LIST T1
	       LEFT JOIN T_PAY_ITEM T2 ON T1.T_PAY_ITEM_PKID = T2.PKID
	       LEFT JOIN T_PAY_STYLE T3 ON T2.PAY_TYPE_PKID = T3.PKID
	        LEFT JOIN T_STUDENT T5 on T5.PKID=T1.STUDENT_PKID
	       LEFT JOIN T_STUDENT_BM T4 ON T1.STUDENT_BM_PKID = T4.PKID
	       WHERE 1=1 AND T4.ZHUANGTAI = 1 AND T4.IS_TONGGUO!=0
		   <!-- <if test="pd.studentPkid!=null and pd.studentPkid!=''">
			   <if test="pd.pkidMain==null or pd.pkidMain==''">
			    	and T4.PKID = #{pd.studentPkid}
			   </if>
		   </if> -->
		   <if test="pd.pkidMain!=null and pd.pkidMain!=''">
		    	and T4.STUDENT_PKID = #{pd.pkidMain}
		   </if>
		   <if test="pd.status!=null and pd.status!=''">
		    	AND T1.STATUS=#{pd.status}
		   </if>
			ORDER BY RXNIANFEN DESC,t1.CJSJ DESC 
    </select>
    
    
    <select id="getStuYJInfo" parameterType="pd" resultType="pd">
		select l.*,i.* 
		from t_pay_item_list l
		join t_student s on s.pkid = l.STUDENT_PKID
		join t_pay_item i on i.pkid = l.T_PAY_ITEM_PKID
		where 
		exists (
			select 1 from t_student_bm sb where sb.pkid = #{STUDENT_BM_PKID} and sb.STUDENT_PKID = s.pkid
		)
		AND I.PAY_TYPE_PKID = '12345678902'
		AND I.GRADE_PKID = S.YJ_NIANFEN
		AND I.CLASSTYPE_PKID = S.YJ_BANJI_TYPE_PKID
		AND L.STATUS != 3
		AND ROWNUM = 1
	</select>
    
    
    <select id="getitemlistmax" resultType="pd" parameterType="pd">
	
	
			SELECT * FROM(
		SELECT 
		R.PKID REPPKID,
		R.YOUHUI_TYPE,
		R.ZENGJIAN_TYPE COST_TYPE,
		R.ZENGJIAN_JINE COSTS,
		(CASE 
		WHEN R.ZENGJIAN_TYPE=1 THEN 0-R.ZENGJIAN_JINE
		WHEN R.ZENGJIAN_TYPE=0 THEN R.ZENGJIAN_JINE
		END)COST,
		row_number() over (partition by R.YOUHUI_TYPE order by (CASE 
		WHEN R.ZENGJIAN_TYPE=1 THEN 0-R.ZENGJIAN_JINE
		WHEN R.ZENGJIAN_TYPE=0 THEN R.ZENGJIAN_JINE
		END) desc) as rank,
		F.*
		 
		FROM T_PAY_ITEM_RULE R
		LEFT JOIN T_PAY_ITEM_RULE_FB F ON F.T_PAY_ITEM_RULE_PKID=R.PKID
		WHERE R.T_PAY_ITEM_PKID=#{IPKID} AND R.YOUHUI_TYPE=#{YOUHUI_TYPE}
		<if test="HZXY!=null and HZXY!=''"> <!-- 查询条件 合作学校 -->
		AND F.HZXY LIKE '%${HZXY}%'
		</if>
		<if test="BMSHIJIAN !=null and BMSHIJIAN!=''">
		AND
		F.BAOMINGTIMEQ&lt;=to_date('${BMSHIJIAN}','yyyy-mm-dd')
		AND
		F.BAOMINGTIMEZ&gt;=to_date('${BMSHIJIAN}','yyyy-mm-dd')
		</if>
		<if test="XK_MARK!=null and XK_MARK!=''"> <!-- 查询条件 美院 -->
		AND F.SYS_MEI_DEPARTMENT_PKIDS LIKE '%${XK_MARK}%'
		</if>
		
		<if test="CENGCI!=null and CENGCI!=''">
		AND F.CENGCI LIKE '%${CENGCI}%'
		</if>
		
		<if test="LKFS!=null and LKFS!=''">
		AND F.ZUIGAOFEN&gt;=#{LKFS}
		AND F.ZUIDIFEN&lt;=#{LKFS}
		</if>
		
		<if test="BANJIPKID!=null and BANJIPKID!=''">
		AND F.T_CLASS_PKIDS LIKE '%${BANJIPKID}%'
		</if>
		
		
		
		
		)WHERE rank=1
	
	</select>
    
    	<select id="getallrulebypkid" parameterType="pd" resultType="pd">
		
		 select *  from T_PAY_ITEM_RULE e where e.t_pay_item_pkid=#{T_PAY_ITEM_PKID}
		   
    	</select>
    
    
    <select id="getPayItemlistByStudentPkidAndStatus" parameterType="pd" resultType="pd">

	select t1.pkid,t2.payitem,t2.startdate,t2.enddate,t1.status,t1.cost,t1.discount,t1.amountreceivable,t1.amountcollection
	from t_pay_item_list t1 
	left join t_pay_item t2
	on t1.pay_item_pkid = t2.pkid
	left join t_student t3
	on t1.student_pkid = t3.pkid
	where 1=1
	<if test="studentPkid!=null and studentPkid!=''">
    	and t3.pkid=#{studentPkid}
    </if>
	and t2.startusing='Y'
	and t2.status in (1,2)
	ORDER BY t1.XGSJ DESC 
    </select>
    
    <!-- 获得线下缴费记录列表 -->
    <select id="getPayOrderDetailList" parameterType="pd" resultType="pd">

			SELECT T1.PKID,T1.PAY_ITEM_PKID,T1.INPUT_OUTPUT,
			(CASE WHEN SU.NAME IS NULL THEN '院方' ELSE SU.NAME END) AS NAME,
			CASE
			  WHEN T2.TRANSACTION_TYPE='SF' THEN '收费'
			  WHEN T2.TRANSACTION_TYPE='TF' THEN '退费'
			END TRANSACTION_TYPE,
			CASE
			  WHEN T2.ORDERCREATE_MODE='U' THEN '线上'
			  WHEN T2.ORDERCREATE_MODE='I' THEN '导入'
			  WHEN T2.ORDERCREATE_MODE='D' THEN '线下'
			  WHEN T2.ORDERCREATE_MODE='DO' THEN '线下其他'
			END ORDERCREATE_MODE,
			CASE
			  WHEN T1.PRINTFLAG='Y' THEN '已打'
			  WHEN T1.PRINTFLAG='N' THEN '未打'
			END PRINTFLAG,
			
			CASE
			  WHEN T1.STATUS='1' THEN '正常'
			  WHEN T1.STATUS='2' THEN '转入'
			  WHEN T1.STATUS='3' THEN '转出'
			END STATUS,
			CASE
			  WHEN ODM.PAY_MODE='CASH' AND ODM.MONEY>0 THEN '现金'
			  WHEN ODM.PAY_MODE='CARD' AND ODM.MONEY>0 THEN '银行卡'
			  WHEN ODM.PAY_MODE='WX' AND ODM.MONEY>0 THEN '微信'
			  WHEN ODM.PAY_MODE='ZFB' AND ODM.MONEY>0 THEN '支付宝'
			  WHEN ODM.PAY_MODE='TT' AND ODM.MONEY>0 THEN '电汇'
			END PAY_MODE,
			ODM.MONEY AS "totalMoney",
			to_char(T1.CJSJ,'YYYY-MM-DD HH24:MI:SS') CJSJ
			FROM T_PAY_ORDER_DETAIL T1
			JOIN T_PAY_ORDER_DETAIL_MONEY ODM ON ODM.PAY_ORDER_DETAIL_PKID = T1.PKID
			JOIN T_PAY_ORDER T2
			ON T1.PAY_ORDER_PKID = T2.PKID
			JOIN T_STUDENT T3
			ON T2.STUDENT_PKID = T3.PKID
			LEFT JOIN SYS_USER SU ON SU.USER_ID = T1.CJR
			WHERE 1=1 AND T2.TRANSACTION_FLAG=1 AND T1.MONEY>0
			AND ODM.MONEY>0
			<if test="createModels!=null">
				AND T2.ORDERCREATE_MODE IN 
				<foreach item="item" index="index" collection="createModels" open="(" separator="," close=")"> 
				   #{item}  
				  </foreach>
		    </if>
			
			<if test="studentPkid!=null and studentPkid!=''">
		    	AND T3.PKID=#{studentPkid}
		    </if>
		    <if test="payItemListPkid!=null and payItemListPkid!=''">
		    	AND T1.T_PAY_ITEM_LIST_PKID=#{payItemListPkid}
		    </if>
			ORDER BY T1.XGSJ DESC 
    </select>
    
    <!-- 获得缴费记录金额和支付方式列表 -->
    <select id="getPayOrderDetailMoneyList" parameterType="pd" resultType="pd">

	SELECT * FROM T_PAY_ORDER_DETAIL_MONEY T WHERE 1=1 
	<if test="orderDetailPkid!=null and orderDetailPkid!=''">
    	AND T.PAY_ORDER_DETAIL_PKID=#{orderDetailPkid}
    </if>
	
    </select>
    
    <!-- 获得缴费名单 -->
    <select id="getPayItemList" parameterType="pd" resultType="pd">

	SELECT T1.PAY_ITEM_PKID,T2.PAYITEM,T1.COST,T3.DISCOUNT_SCOPE,T3.DISCOUNT_MODE,T3.DISCOUNT_MONEY,T3.DISCOUNT,T1.AMOUNTRECEIVABLE,T1.AMOUNTCOLLECTION,T1.STATUS,T1.DISCOUNT DISCOUNTS
	FROM T_PAY_ITEM_LIST T1
	LEFT JOIN T_PAY_ITEM T2
	ON T1.PAY_ITEM_PKID = T2.PKID
	LEFT JOIN T_PAY_ITEM_LIST_DISCOUNT T3
	ON T1.PAY_ITEM_PKID = T3.PAY_ITEM_LIST_PKID
	WHERE 1=1 
	<if test="studentPkid!=null and studentPkid!=''">
    	AND T1.STUDENT_PKID=#{studentPkid}
    </if>
    <if test="payItemPkid!=null and payItemPkid!=''">
    	AND T1.PAY_ITEM_PKID=#{payItemPkid}
    </if>
    </select>
    
    
    <!-- 获得缴费详情 -->
    <select id="getPayOrderDetail" parameterType="pd" resultType="pd">

	SELECT CASE
	  WHEN T2.ORDERCREATE_MODE='D' THEN '线下'
	  WHEN T2.ORDERCREATE_MODE='DO' THEN '线下其他'
	  WHEN T2.ORDERCREATE_MODE='I' THEN '导入'
	  WHEN T2.ORDERCREATE_MODE='U' THEN '线上'
	END ORDERCREATE_MODE,
	
	TO_CHAR(T2.ORDERDATE, 'YYYY-MM-DD HH24:mi:ss') ORDERDATE,
	T2.CJR,T1.PAY_ORDERNO,T3.TRANSACTION_HOST_SN,
	TO_CHAR(T5.CJSJ, 'YYYY-MM-DD HH24:mi:ss') DCJSJ,
	TO_CHAR(T3.CJSJ, 'YYYY-MM-DD HH24:mi:ss') CJSJ,
	T1.PKID,
	T3.TRANSACTION_PAY_PLATFORM,
	T1.MONEY,T4.USERNAME
	from T_PAY_TRANSACTION_LOG T3
	LEFT JOIN T_PAY_ORDER T2
	ON T3.PAY_ORDER_PKID = T2.PKID
	LEFT JOIN T_PAY_ORDER_DETAIL T1
	ON T2.PKID=T1.PAY_ORDER_PKID
	LEFT JOIN T_PAY_ITEM T5
	ON T5.PKID=T1.PAY_ITEM_PKID
	LEFT JOIN SYS_USER T4
	ON T2.CJR = T4.USER_ID

	WHERE 1=1 AND t3.TRANSACTION_STATUS in (1,2)
	<if test="orderDetailPkid!=null and orderDetailPkid!=''">
    	AND T1.PKID=#{orderDetailPkid}
    </if>
    </select>
    
    <!-- 修改订单明细 -->
    <update id="updatePayOrderDetail" parameterType="pd">
    	update T_PAY_ORDER_DETAIL 
    	set 
    	XGSJ=SYSDATE
    	<if test="printFlag!=null and printFlag!=''">
    	,PRINTFLAG=#{printFlag}
    	</if>
    	<if test="XGR!=null and XGR!=''">
    	,XGR=#{XGR}
    	</if>
    	WHERE PKID=#{orderDetailPkid}
    	
    	
    </update>
    
    <!-- 获得所有缴费记录 -->
    <select id="getPayOrderDetailGroup" parameterType="pd" resultType="pd">

	SELECT TT.PAY_ITEM_PKID 
	FROM(SELECT * 
	FROM T_PAY_ORDER_DETAIL T1
	LEFT JOIN T_PAY_ITEM T2
	ON T1.PAY_ITEM_PKID = T2.PKID
	LEFT JOIN T_PAY_OTHER_ITEM T3
	ON T1.PAY_ITEM_PKID = T3.PKID
	WHERE 1=1
	<if test="printFlag!=null and printFlag!=''">
    	AND T1.PRINTFLAG=#{printFlag}
    </if>
    <if test="studentPkid!=null and studentPkid!=''">
    	AND T1.STUDENT_PKID=#{studentPkid}
    </if>
    <if test="payItemPkids!=null">
		AND T1.PAY_ITEM_PKID IN
		<foreach item="item" index="index" collection="payItemPkids" open="(" separator="," close=")"> 
		   #{item}  
		  </foreach>
    </if>
	) TT GROUP BY TT.PAY_ITEM_PKID
    </select>
    
    
    <!-- 获得线下缴费记录列表 -->
    <select id="getPayOrderDetailListForPrint" parameterType="pd" resultType="pd">

	SELECT T1.PKID,T1.PAY_ITEM_PKID,T1.CJSJ,T2.TRANSACTION_TYPE,T2.ORDERCREATE_MODE,T1.PRINTFLAG,T4.PAYITEM 
	FROM T_PAY_ORDER_DETAIL T1
	 
	LEFT JOIN T_PAY_ORDER T2
	ON T1.PAY_ORDER_PKID = T2.PKID
	LEFT JOIN T_STUDENT T3
	ON T2.STUDENT_PKID = T3.PKID
	LEFT JOIN T_PAY_ITEM T4
	ON T1.PAY_ITEM_PKID = T4.PKID
	LEFT JOIN T_PAY_OTHER_ITEM T5
	ON T1.PAY_ITEM_PKID = T5.PKID
	
	WHERE 1=1 AND T2.TRANSACTION_FLAG=1 AND T1.PRINTFLAG !='Y' 
	<if test="createModels!=null">
		AND T2.ORDERCREATE_MODE IN 
		<foreach item="item" index="index" collection="createModels" open="(" separator="," close=")"> 
		   #{item}  
		  </foreach>
    </if>
	<if test="studentPkid!=null and studentPkid!=''">
    	AND T3.PKID=#{studentPkid}
    </if>
    <if test="payItemPkid!=null and payItemPkid!=''">
    	AND T1.PAY_ITEM_PKID=#{payItemPkid}
    </if>
	ORDER BY T1.XGSJ DESC 
    </select>
    

    <!--所有的缴费项目  -->
    <select id="getAllPayItems" parameterType="pd" resultType="pd">
    	select pkid,payitem from t_pay_item where 1=1
    </select>
    
    <!-- 更新缴费项目状态  已完成  已过期  -->
    <update id="updatePayItemStatus" useGeneratedKeys="false" parameterType="pd">
    	update t_pay_item i set i.status=(case when i.status=1 then 2  when i.status=0 then 3 else i.status end),XGSJ=sysdate 
		where enddate is not null 
		and enddate &lt; sysdate
    </update>
    
    
    <!-- 未缴费学生名单 -->
	
	<select id="getStudentPaylistPage" parameterType="page" resultType="pd">

	SELECT T1.PKID,T1.XINGMING,T1.XUEHAO,T1.DEPARTMENT_PKID,T1.XINGBIE,T1.RUXUESHIJIAN,T1.NIANJI,T1.ZAIXUEZT,T1.SUSHE,T1.DAOSHI,T1.SHENFENZHENGHAO,
	(select name from SYS_DEPARTMENT T3 where T1.DEPARTMENT_PKID = T3.DEPARTMENT_ID) DEPARTMENT_NAME,
	(select name from SYS_DICTIONARIES T4 where T1.ZAIXUEZT = T4.DICTIONARIES_ID  ) ZAIXUEZT_NAME
	FROM T_STUDENT T1  
	WHERE T1.ZHUANGTAI=1 AND T1.PKID NOT IN   
	(SELECT T2.STUDENT_PKID FROM T_PAY_ITEM_LIST T2   
	
	<if test="pd.payItemPkid!=null and pd.payItemPkid!=''">
    	WHERE T2.PAY_ITEM_PKID=#{pd.payItemPkid}
    </if>
	    GROUP BY T2.STUDENT_PKID)
	<if test="pd.conditions!=null and pd.conditions!=''">
   		AND (
   		T1.XUEHAO LIKE CONCAT(CONCAT('%', #{pd.conditions}),'%')
   		or T1.SHENFENZHENGHAO LIKE CONCAT(CONCAT('%', #{pd.conditions}),'%') 
   		or T1.XINGMING LIKE CONCAT(CONCAT('%', #{pd.conditions}),'%') 
   		)
   	</if>
	  ORDER BY T1.XGSJ
    </select>
    
    
    <select id="getManeyChangelistPage" parameterType="page" resultType="pd">

	 SELECT G.*,TO_CHAR(G.CJSJ,'YYYY-MM-DD HH24:MI:SS') SJ,(select name  from sys_user e where e.username=g.ccz) CCRNAME FROM t_pay_item_list_changelog G WHERE G.T_PAY_ITEM_LIST_PKID=#{pd.T_PAY_ITEM_LIST_PKID}
	  ORDER BY G.CJSJ DESC
    </select>
    
    <select id="getManeyLOGlistPage" parameterType="page" resultType="pd">
    
    
    SELECT P.*,CASE WHEN P.ORDERCREATE_MODE='U' then '院方' else (select name from sys_user e where e.USER_ID=p.cjr) end CZR  FROM 
(select L.PKID,
       l.INPUT_OUTPUT,
       m.MONEY,
       l.SKR,
        l.cjr,
       to_char(l.cjsj, 'yyyy-MM-dd HH24:mi:ss') CJSJ,
       r.ORDERCREATE_MODE,
       m.PAY_MODE
  from t_pay_order_detail l
   join T_PAY_ORDER r on r.pkid = l.PAY_ORDER_PKID
   join T_PAY_ORDER_DETAIL_MONEY m on m.pay_order_detail_pkid = l.pkid and m.MONEY>0
 where l.T_PAY_ITEM_LIST_PKID = #{pd.T_PAY_ITEM_LIST_PKID} AND r.transaction_flag = 1 order  by l.cjsj desc) P
    

	
    </select>
    
    
     
    <!-- 保存缴费名单 -->
	<insert id="savePayItemList" parameterType="pd">
		INSERT INTO 
		T_PAY_ITEM_LIST
		(PKID,STUDENT_PKID,STATUS,COST,DISCOUNT,AMOUNTRECEIVABLE,AMOUNTCOLLECTION,
		DISCOUNT_MONEY,DISCOUNT_MODE,STUDENT_BM_PKID,T_PAY_ITEM_PKID)
		VALUES 
		(SYS_GUID(),#{stuPkid},0,#{COST},#{DISCOUNT},#{COST},
		0,0,0,#{stuBmPkid},#{T_PAY_ITEM_PKID})
	</insert>
		
	<!-- 获得缴费记录个数 -->
    <select id="getCountFromPayItemList" parameterType="pd" resultType="pd">
	
		SELECT COUNT(*) ccount FROM T_PAY_ITEM_LIST T WHERE 1=1 
		<if test="studentPkid!=null and studentPkid!=''">
	    	AND T.STUDENT_PKID=#{studentPkid}
	    </if>
	    <if test="payItemPkid!=null and payItemPkid!=''">
	    	AND T.PAY_ITEM_PKID=#{payItemPkid}
	    </if>
    </select>
    
    <!-- 根据id获得对象-->
    <select id="getPayItemInfo" parameterType="pd" resultType="pd">
    	select COST,STATUS from T_PAY_ITEM 
    	where 1=1 
    	and PKID=#{PKID}
    </select>
    
    <!-- 获得缴费名单 -->
    <select id="getPayItemListList" parameterType="pd" resultType="pd">
    	       select t.PKID,u.shenfenzhenghao,s.XUEHAO,u.xingming,S.RXNIANFEN_PKID,S.BANJI_TYPE_PKID,
(select name from SYS_DICTIONARIES D where d.PARENT_ID = 'GRADE' AND D.DICTIONARIES_ID=S.RXNIANFEN_PKID) RUXUENIANFEN,
(select name from SYS_DICTIONARIES D where d.PARENT_ID = 'CLASSTYPE' AND D.DICTIONARIES_ID=S.BANJI_TYPE_PKID) BANXING,
S.BANJI,
(select CLASS_NAME from T_CLASS S WHERE S.PKID=S.BANJI) CLASS_NAME,
      (case when t.status = '0' then '欠费' when t.status = '1' then '核验中' when t.status = '2' then '已完成' when t.status = '3' then '已关闭' end) ztstatus,
       sy.pay_style_name,
      t.status,
      to_char(t.AMOUNTRECEIVABLE,'fm999999990.00')AMOUNTRECEIVABLE,to_char(t.AMOUNTCOLLECTION,'fm999999990.00')AMOUNTCOLLECTION,
       to_char((t.AMOUNTRECEIVABLE-t.AMOUNTCOLLECTION),'fm999999990.00') QIANFEI
      from T_PAY_ITEM_LIST t
      join T_PAY_ITEM i on i.PKID=T.T_PAY_ITEM_PKID
       join t_pay_style sy on i.pay_type_pkid=sy.pkid
      left join t_Student_Bm s on t.STUDENT_BM_PKID = s.PKID
      left join t_student u on u.pkid=s.student_pkid
      where 1=1  and s.ZHUANGTAI='1' and s.ZXZT='ZX' and s.IS_TONGGUO!=0 AND T.T_PAY_ITEM_PKID=#{payItemPkid} 
      <if test="RXNIANFEN_PKID!=null and RXNIANFEN_PKID!=''">
		and S.RXNIANFEN_PKID = #{RXNIANFEN_PKID} 
		</if>
    
    <if test="BANJI_TYPE_PKID!=null and BANJI_TYPE_PKID!=''">
		and S.BANJI_TYPE_PKID = #{BANJI_TYPE_PKID} 
		</if>
     <if test="STATUS!=null and STATUS!=''">
		and T.STATUS = #{STATUS} 
		</if>
   <if test="conditions!=null and conditions!=''">
	   		and (
	   		s.XUEHAO LIKE CONCAT(CONCAT('%', #{conditions}),'%')
	   		or u.SHENFENZHENGHAO LIKE CONCAT(CONCAT('%', #{conditions}),'%') 
	   		or u.XINGMING LIKE CONCAT(CONCAT('%', #{conditions}),'%') 
	   		)
	   	</if>
	ORDER BY t.XGSJ DESC 
	</select>
	
	
	 <!-- 得到学生flag -->
    <select id="yanzmc" parameterType="pd" resultType="pd">
	select * from t_pay_item t  where t.payitem=#{MC}
	</select>
	
	<!-- 获得所有缴费条数 -->
    <select id="getPayOrderDetailCount" parameterType="pd" resultType="pd">
		select count(*) CCOUNT from T_PAY_ORDER_DETAIL where 1=1 
		<if test="payItemPkid!=null and payItemPkid!=''">
    	and PAY_ITEM_PKID=#{payItemPkid}
    	</if>
    	<if test="studentPkid!=null and studentPkid!=''">
    	 and STUDENT_PKID=#{studentPkid}
    	</if>
    </select>
	

	<!--导出缴费名单 kangchl -->
	<select id="getCanExportPayItemList" parameterType="pd" resultType="pd">
    	select t.PKID,
		i.PAYITEM,
	  	p.pici_name,
	  	c.cengci_name,
	  	s.nianji,
	  	(case when t.status = '0' then '欠费' when t.status = '1' then '核验中' when t.status = '2' then '已完成' when t.status = '3' then '已关闭' end) status,
	  	t.PAY_ITEM_PKID,t.COST,t.DISCOUNT,t.AMOUNTRECEIVABLE,t.AMOUNTCOLLECTION, s.PKID SPKID,s.SHENFENZHENGHAO,s.XINGMING,s.DEPARTMENT_PKID,
	  	(t.AMOUNTRECEIVABLE-t.AMOUNTCOLLECTION) AMOUNTQF,
	  	departmentstr(s.department_pkid) ZUZHINAME 
	  	from T_PAY_ITEM_LIST t
	  	join T_PAY_ITEM i on i.PKID=T.PAY_ITEM_PKID and i.status in (1,2)
	  	left join T_STUDENT s on t.student_pkid = s.pkid
	  	left join t_pici p on p.pkid = s.pici_pkid
	  	left join t_cengci c on c.pkid = s.cengci_pkid
	  	where 1=1 and s.ZAIXUEZT='ZX'
		<if test="payitempkid!=null and payitempkid!=''">
	    	AND t.PAY_ITEM_PKID=#{payitempkid}
	    </if>
		
		<if test="status!=null and status!=''">
	    	AND t.status=#{status}
	    </if>
	    <if test="nianji!=null and nianji!=''">
	    	AND s.nianji=#{nianji}
	    </if>
		<!-- <if test="DEPARTMENT_PKID!=null and DEPARTMENT_PKID!=''">
	    	AND s.DEPARTMENT_PKID=#{DEPARTMENT_PKID}
	    </if> -->
	    <if test="DEPARTMENT_PKID!=null and DEPARTMENT_PKID.size() > 0">
			AND s.DEPARTMENT_PKID IN 
			<foreach item="item" index="index" collection="DEPARTMENT_PKID" open="(" separator="," close=")"> 
			   #{DEPARTMENT_PKID[${index}]}
			  </foreach>
	    </if>
	    <!-- <if test="keywords!=null and keywords!=''">
	    	AND (
	    	s.shenfenzhenghao=#{keywords} or 
	    	s.xingming=#{keywords} or
	    	s.xuehao=#{keywords}
	    	)
	    </if> -->
	    
	    <if test="keywords!=null and keywords!=''">
	   		and (
	   		s.XUEHAO LIKE CONCAT(CONCAT('%', #{keywords}),'%')
	   		or s.SHENFENZHENGHAO LIKE CONCAT(CONCAT('%', #{keywords}),'%') 
	   		or s.XINGMING LIKE CONCAT(CONCAT('%', #{keywords}),'%') 
	   		)
	   	</if>
   ORDER BY  T.XGSJ DESC
	</select>

	 <delete id="deleteItem" parameterType="pd">
    	DELETE FROM T_PAY_ITEM WHERE PKID=#{pkid}
    </delete>
    <delete id="deleteItemrulefb" parameterType="pd">
    	delete from t_pay_item_rule_fb fb where exists (
    		select 1 from t_pay_item_rule r where r.pkid = fb.T_PAY_ITEM_RULE_PKID
    		and r.T_PAY_ITEM_PKID=#{pkid}
    	)
    	
    </delete>
     <delete id="deleteItemrule" parameterType="pd">
    	DELETE FROM t_pay_item_rule t  where t.T_PAY_ITEM_PKID=#{pkid}
    </delete>
     <delete id="deleteItemlist" parameterType="pd">
    	DELETE FROM t_pay_item_list t  where t.PAY_ITEM_PKID=#{pkid}
    </delete>
	
	<!--批量   更改缴费名单表状态   更新名单状态为已关闭-->
	<update id="updatePayItemListStatusClose" parameterType="pd">
		update t_pay_item_list l set l.xgsj=sysdate  
		where exists(
		      select 1 from t_pay_item i where i.pkid=l.T_PAY_ITEM_PKID
		)
		and l.status!=3 and l.status!=2   
	</update>
	<!-- end 更改缴费名单表状态 -->
	
	
	<!--批量   更改缴费名单表状态   更新名单状态为已完成-->
	<update id="updatePayItemListStatusOk" parameterType="pd">
		update t_pay_item_list l set l.status=2 ,l.xgsj=sysdate,OFFTHESTOCKS_DATE=sysdate   
		where l.Amountcollection=l.AMOUNTRECEIVABLE  
		and not exists(
		     select 1 from t_pay_order o inner join t_pay_transaction_log tl on(tl.pay_order_pkid=o.pkid) inner join t_pay_order_detail od 
		     on(od.pay_order_pkid=o.pkid)
		     where o.student_pkid=l.student_pkid and od.T_PAY_ITEM_LIST_PKID=l.PKID
		     and tl.transaction_status in (1,-1) 
		)
		and l.status!=2
	</update>
	<!-- 更改缴费名单表状态   更新名单状态为已完成-->
	<!-- 保存缴费名单删除表 -->
	<insert id="insertPayItemListDel" parameterType="pd">
		INSERT INTO 
		T_PAY_ITEM_LIST_DEL
		(pkid, student_pkid, cjsj, xgsj, status, cost, discount, amountreceivable, amountcollection, discount_money, discount_mode,student_bm_pkid, t_pay_item_pkid)
		VALUES 
		( sys_guid(),#{STUDENT_PKID},SYSDATE,SYSDATE,#{STATUS},#{COST},#{DISCOUNT,jdbcType=VARCHAR},#{AMOUNTRECEIVABLE},#{AMOUNTCOLLECTION},#{DISCOUNT_MONEY},#{DISCOUNT_MODE},#{STUDENT_BM_PKID,jdbcType=VARCHAR},#{T_PAY_ITEM_PKID,jdbcType=VARCHAR})
	</insert>
	
	<!--删除缴费名单表  -->
    <delete id="deletePayItemList" parameterType="pd">
    	DELETE FROM T_PAY_ITEM_LIST WHERE T_PAY_ITEM_PKID=#{payItemPkid}
    </delete>
    
    <!--删除缴费名单  -->
    <delete id="deletePayItemListObject" parameterType="pd">
    	DELETE FROM T_PAY_ITEM_LIST WHERE PKID=#{pkid}
    </delete>
    
<update id="updateitem" parameterType="pd">
		update T_PAY_ITEM t set t.payitem=#{fabuxm},t.cost=#{fabuje}, t.mustpay=#{MUSTPAY}, t.startdate=to_date(#{yxqqi},'yyyy-mm-dd hh24:mi:ss'), 
		t.enddate=to_date(#{yxqzhi},'yyyy-mm-dd hh24:mi:ss'),t.XGSJ=sysdate,t.XGR=#{CJR} WHERE t.PKID=#{pkid}
	</update>
	
	 <delete id="deletedr" parameterType="pd">
    	DELETE FROM T_PAY_ITEM_LIST WHERE PAY_ITEM_PKID=#{pkid}
    </delete>
    <select id="getlist" parameterType="pd" resultType="pd">
    select nvl(t.discount_money, 0) discount_money,
       (select s.SHENFENZHENGHAO
          from t_student s
         where s.pkid = t.student_pkid) cardNo,
       (select s.XUEHAO from t_student s where s.pkid = t.student_pkid) stuNumber,
       (select s.XINGMING from t_student s where s.pkid = t.student_pkid) stuName
  from t_pay_item_list t
 where t.pay_item_pkid = #{PKID}
    </select>
    
    <!-- 添加 -->
    <insert id="insertPayItemListDiscount" parameterType="pd">
	  insert into t_pay_item_list_discount
	  (PKID,XGSJ,CJSJ,DISCOUNT_SCOPE,DISCOUNT_MONEY,DISCOUNT,DISCOUNT_MODE,PAY_ITEM_LIST_PKID,ALONEFLAG)
	  VALUES(#{PKID},sysdate,sysdate,null,#{discountMoney},#{discountZhe},#{discountMode},#{payItemListPkid},#{ALONEFLAG})
 	</insert>
 	
 	<delete id="deletePayItemListDiscount" parameterType="pd">
    	DELETE FROM t_pay_item_list_discount WHERE PAY_ITEM_LIST_PKID=#{payItemListPkid}
    </delete>
    
    <!-- 根据id获得对象-->
    <select id="getPayItemListInfoLock" parameterType="pd" resultType="pd">
    	select COST,DISCOUNT,AMOUNTRECEIVABLE,STUDENT_PKID,PAY_ITEM_PKID from T_PAY_ITEM_LIST 
    	where 1=1 
    	and PKID=#{PKID} for update
    </select>

	<!-- 获取缴费名单/暂打印时使用 -->
    <select id="getPayItemListForPrint" parameterType="pd" resultType="pd">
    	select t1.pkid,t1.cjsj,t1.PAY_ITEM_PKID,t2.payitem,t2.startdate,t2.enddate,t1.status,t1.cost,t1.discount,t1.amountreceivable,t1.amountcollection,t3.XINGMING,
    	(select w.name from sys_department w where w.department_id=t3.DEPARTMENT_PKID) ZUZHINAME 
		from t_pay_item_list t1 
		left join t_pay_item t2
		on t1.pay_item_pkid = t2.pkid
		left join t_student t3
		on t1.student_pkid = t3.pkid
		where 1=1
		<if test="payItemListPkidList!=null and payItemListPkidList.size() > 0">
			AND T1.PKID IN 
			<foreach item="item" index="index" collection="payItemListPkidList" open="(" separator="," close=")"> 
			   #{item}  
			  </foreach>
	    </if>
		<if test="studentPkid!=null and studentPkid!=''">
	    	AND t3.pkid=#{studentPkid}
	    </if>
		and t2.startusing='Y'
		and t2.status in (1,2)
		ORDER BY t1.XGSJ DESC 
    </select>
    
     <!-- 线下缴费查询学生名单 -->
	
	<select id="getStudentQuerylistPage" parameterType="page" resultType="pd">

		SELECT T.XINGMING,T.SHENFENZHENGHAO,T.WHKXUEXIAO,TB.RXNIANFEN_PKID,TB.BANJI_TYPE_PKID,
		T.PKID,TB.PKID AS TBPKID,
		(SELECT SCHOOLNAME FROM T_PART_SCHOOL TP WHERE TP.PKID = T.WHKXUEXIAO) WHKXUEXIAONAME,
		(CASE WHEN TB.ZXZT = 'ZX' then '在学' WHEN TB.ZXZT = 'TX' then '退学'  WHEN TB.ZXZT = 'BY' then '毕业' ELSE ''END) ZXZT,
		(SELECT D.NAME FROM sys_dictionaries D WHERE D.DICTIONARIES_ID = TB.RXNIANFEN_PKID) RXNIANFEN, 
		(SELECT D.NAME FROM sys_dictionaries D WHERE D.DICTIONARIES_ID = T.YJ_NIANFEN) YJ_NIANFEN,   
		(SELECT D.NAME FROM sys_dictionaries D WHERE D.DICTIONARIES_ID = TB.BANJI_TYPE_PKID) BANJI_TYPE,
		(SELECT TC.CLASS_NAME FROM T_CLASS TC WHERE TC.PKID = TB.BANJI) BANJINAME,TB.XUEHAO  
		FROM T_STUDENT T LEFT JOIN T_STUDENT_BM TB ON T.PKID = TB.STUDENT_PKID  	
	   <!--  LEFT JOIN T_PAY_ITEM_LIST TL ON T.PKID = TL.STUDENT_PKID -->
		WHERE TB.ZHUANGTAI=1 AND TB.IS_TONGGUO!=0
		<!-- <if test="pd.status!=null and pd.status!=''">
	    	AND TL.STATUS=#{pd.status}
	    </if> -->
		<if test="pd.sfzh!=null and pd.sfzh!=''">
	    	AND T.SHENFENZHENGHAO=#{pd.sfzh}
	    </if>
		<if test="pd.studentBmPkid!=null and pd.studentBmPkid!=''">
	    	AND TB.PKID !=#{pd.studentBmPkid}
	    </if>
		<if test="pd.conditions!=null and pd.conditions!=''">
	   		AND (
	   		TB.XUEHAO LIKE CONCAT(CONCAT('%', #{pd.conditions}),'%')
	   		or T.SHENFENZHENGHAO LIKE CONCAT(CONCAT('%', #{pd.conditions}),'%') 
	   		or T.XINGMING LIKE CONCAT(CONCAT('%', #{pd.conditions}),'%') 
	   		)
	   	</if>
		  ORDER BY TB.XGSJ DESC
    </select>
    
    <!-- 查询学生基本信息-->
    <select id="getStudentInfo" parameterType="pd" resultType="pd">
    	select t.XINGMING,t.shenfenzhenghao,t.xuehao,t.pkid,t.nianji,t.ZHUANYE,t.department_pkid,
    	(SELECT s.NAME FROM sys_dictionaries s WHERE s.BIANMA=t.zaixuezt) zxzt,
    	t.xiaoqu,
    	(select d.name from sys_department d where d.department_id=t.department_pkid) zuzhi
    	 from t_student T where 1=1 and zhuangtai=1 
    	<if test="studentPkid !=null and studentPkid!=''">
    		AND T.PKID=#{studentPkid}
    	</if>
    </select>
    
    <!-- 查询学生基本信息-->
    <select id="getStudentInfo2" parameterType="pd" resultType="pd">
    	SELECT T.XINGMING,T.SHENFENZHENGHAO,T.WHKXUEXIAO,TB.RXNIANFEN_PKID,TB.BANJI_TYPE_PKID,
		T.PKID,TB.PKID AS TBPKID,
		(SELECT SCHOOLNAME FROM T_PART_SCHOOL TP WHERE TP.PKID = T.WHKXUEXIAO) WHKXUEXIAONAME,
		(CASE WHEN TB.ZXZT = 'ZX' then '在学' WHEN TB.ZXZT = 'TX' then '退学'  WHEN TB.ZXZT = 'BY' then '毕业' ELSE ''END) ZXZT,
		(SELECT D.NAME FROM sys_dictionaries D WHERE D.DICTIONARIES_ID = TB.RXNIANFEN_PKID) RXNIANFEN, 
		(SELECT D.NAME FROM sys_dictionaries D WHERE D.DICTIONARIES_ID = T.YJ_NIANFEN) YJ_NIANFEN,   
		(SELECT D.NAME FROM sys_dictionaries D WHERE D.DICTIONARIES_ID = TB.BANJI_TYPE_PKID) BANJI_TYPE,
		(SELECT TC.CLASS_NAME FROM T_CLASS TC WHERE TC.PKID = TB.BANJI) BANJINAME,TB.XUEHAO  
		FROM T_STUDENT T LEFT JOIN T_STUDENT_BM TB ON T.PKID = TB.STUDENT_PKID  	
		WHERE TB.ZHUANGTAI=1  AND TB.IS_TONGGUO!=0
    	<if test="studentPkid !=null and studentPkid!=''">
    		AND TB.PKID = #{studentPkid}
    	</if>
    </select>
    
    <!-- 查询学生 -->
	<select id="getStudentQuerylist2" parameterType="pd" resultType="pd">

		SELECT T.XINGMING,T.SHENFENZHENGHAO,T.WHKXUEXIAO,TB.RXNIANFEN_PKID,TB.BANJI_TYPE_PKID,
		T.PKID,TB.PKID AS TBPKID,
		(SELECT SCHOOLNAME FROM T_PART_SCHOOL TP WHERE TP.PKID = T.WHKXUEXIAO) WHKXUEXIAONAME,
		(CASE WHEN TB.ZXZT = 'ZX' then '在学' WHEN TB.ZXZT = 'TX' then '退学'  WHEN TB.ZXZT = 'BY' then '毕业' ELSE ''END) ZXZT,
		(SELECT D.NAME FROM sys_dictionaries D WHERE D.DICTIONARIES_ID = TB.RXNIANFEN_PKID) RXNIANFEN, 
		(SELECT D.NAME FROM sys_dictionaries D WHERE D.DICTIONARIES_ID = T.YJ_NIANFEN) YJ_NIANFEN,   
		(SELECT D.NAME FROM sys_dictionaries D WHERE D.DICTIONARIES_ID = TB.BANJI_TYPE_PKID) BANJI_TYPE,
		(SELECT TC.CLASS_NAME FROM T_CLASS TC WHERE TC.PKID = TB.BANJI) BANJINAME,TB.XUEHAO  
		FROM T_STUDENT T LEFT JOIN T_STUDENT_BM TB ON T.PKID = TB.STUDENT_PKID  	
		WHERE TB.ZHUANGTAI=1 AND TB.IS_TONGGUO!=0
		<if test="conditions!=null and conditions!=''">
	   		AND (
	   		TB.XUEHAO LIKE CONCAT(CONCAT('%', #{conditions}),'%')
	   		or T.SHENFENZHENGHAO LIKE CONCAT(CONCAT('%', #{conditions}),'%') 
	   		or T.XINGMING LIKE CONCAT(CONCAT('%', #{conditions}),'%') 
	   		)
	   	</if>
    </select>
    
    <!-- 设置欠费项目为关闭 -->
    <update id="updatePayItemListStatusIsClose" parameterType="pd">
		update t_pay_item_list l set l.status=3,l.xgsj=sysdate  
		where 1=1
		<if test="payItemListPkid!=null and cpayItemListPkid!=''">
	   		AND l.PKID = #{payItemListPkid}
	   	</if>
		and l.status = 0
	</update>
	<select id="getDetailByOtherPayItem" parameterType="pd" resultType="pd">
		  select t1.*,t2.USERNAME from T_PAY_ORDER_DETAIL t1
		  left join sys_user t2
		  on t1.cjr= t2.USER_ID
		  where t1.pkid = #{orderDetailPkid}
    </select>
	<select id="getPayStyleList" parameterType="pd" resultType="pd">
		select * from T_PAY_STYLE S WHERE S.IS_USE = 'Y'
	</select>
	<select id="getBanXing" parameterType="pd" resultType="pd">
		select * from SYS_DICTIONARIES D where d.PARENT_ID = 'CLASSTYPE' AND D.IS_USED = 'Y'	
	</select>
	<select id="gethzxxList" parameterType="pd" resultType="pd">
		select * from T_PART_SCHOOL where ZHUANGTAI = '1'
		and ISHEZUO = 'Y'
		order by SCHOOLNAME,FUN_SPELLCODE(SUBSTR(SCHOOLNAME,1,1)),
		cast(REGEXP_SUBSTR(SCHOOLNAME, '[0-9]+') as int)
		
	</select>
	<select id="gethzxxListAdd" parameterType="pd" resultType="pd">
		select * from T_PART_SCHOOL where ZHUANGTAI = '1'
		order by SCHOOLNAME,FUN_SPELLCODE(SUBSTR(SCHOOLNAME,1,1)),
		cast(REGEXP_SUBSTR(SCHOOLNAME, '[0-9]+') as int)
		
	</select>
	<select id="getClassList" parameterType="pd" resultType="pd">
		select * from t_class c where c.SYS_DICTIONARIES_PKID = #{GRADE}
<!-- 		and c.BANXING_PKID = #{CLASSTYPE}  -->
		and c.IS_USE = 1
	</select>
	
	<select id="getMeiYuanList" parameterType="pd" resultType="pd">
		select * from SYS_MEI_DEPARTMENT 
	</select>
	
	
	
	 <select id="getsclist" parameterType="pd" resultType="pd">
     select *  from t_pay_item m 
   join t_pay_item_list l on m.pkid=l.T_PAY_ITEM_PKID 
   join t_pay_order o on o.student_pkid=l.STUDENT_PKID
  where m.pkid= #{payItemPkid}
    </select>
	

	<select id="getlistbyPkid" parameterType="String" resultType="pd">
		select  d.*,t.shenfenzhenghao  from T_PAY_ORDER_DETAIL d left join  t_student t on t.pkid=d.student_pkid
		where d.T_PAY_ITEM_LIST_PKID=#{pkid}
	</select>
	
	<select id="getorderInfo" parameterType="String" resultType="pd">
		SELECT * 
		FROM T_PAY_ORDER O WHERE O.TRANSACTION_FLAG = 1
		AND EXISTS 
		(SELECT 1 FROM T_PAY_ORDER_DETAIL OD WHERE OD.PAY_ORDER_PKID = O.PKID
		AND OD.T_PAY_ITEM_LIST_PKID = #{PKID})
		AND ROWNUM = 1
	</select>
	
	<!-- 根据入学年份和班型pkid查询缴费类型pkid -->
	<select id="getPayTypePkid" parameterType="pd" resultType="pd">
		SELECT * FROM T_PAY_ITEM  T WHERE T.GRADE_PKID =#{stuRXNFPkid} AND T.CLASSTYPE_PKID = #{stuBXPkid}
		AND T.PKID NOT IN (SELECT TP.T_PAY_ITEM_PKID  FROM T_PAY_ITEM_LIST TP WHERE TP.STUDENT_BM_PKID = #{studentBmPkid} )
	</select>
	<!-- 根据预交入学年份和班型pkid查询缴费类型pkid -->
	<select id="getPayTypeYjPkid" parameterType="pd" resultType="pd">
		SELECT T.*,TS.PAY_STYLE_NAME FROM T_PAY_ITEM  T  LEFT JOIN T_PAY_STYLE TS ON T.PAY_TYPE_PKID = TS.PKID 
		WHERE T.GRADE_PKID = (
	    SELECT T1.YJ_NIANFEN FROM T_STUDENT T1 WHERE  T1.PKID = (
	    SELECT TB.STUDENT_PKID FROM T_STUDENT_BM TB WHERE TB.PKID = #{studentBmPkid}))
	    AND T.CLASSTYPE_PKID = (
	    SELECT T1.YJ_BANJI_TYPE_PKID FROM T_STUDENT T1 WHERE  T1.PKID = (
	    SELECT TB.STUDENT_PKID FROM T_STUDENT_BM TB WHERE TB.PKID = #{studentBmPkid}))
	    AND T.PKID NOT IN (SELECT TP.T_PAY_ITEM_PKID  FROM T_PAY_ITEM_LIST TP WHERE TP.STUDENT_BM_PKID = #{studentBmPkid} )
	    AND TS.PAY_STYLE_NAME = '预交'
	</select>
	
	<!-- 根据pkid查询缴费类型-->
	<select id="getPayTypeName" parameterType="pd" resultType="pd">
		  SELECT * FROM T_PAY_STYLE T WHERE T.PKID = #{PAY_TYPE_PKID}
	</select>
	<!-- 根据pkid查询缴费类型-->
	<select id="getYjIsBd" parameterType="pd" resultType="pd">
		  SELECT * FROM T_STUDENT T WHERE T.YJ_STUBM_PKID = #{studentBmPkid}
	</select>
	
	<!-- 保存缴费名单删除备份表 -->
	<insert id="savePayItemListDel" parameterType="pd">
		INSERT INTO 
		T_PAY_ITEM_LIST_DEL
		(PKID,STUDENT_PKID,STATUS,COST,DISCOUNT,AMOUNTRECEIVABLE,AMOUNTCOLLECTION,
		DISCOUNT_MONEY,DISCOUNT_MODE,STUDENT_BM_PKID,T_PAY_ITEM_PKID,CJSJ,XGSJ)
		VALUES 
		(SYS_GUID(),#{STUDENT_PKID},#{STATUS},#{COST},#{DISCOUNT,jdbcType=VARCHAR},#{AMOUNTRECEIVABLE},
		#{AMOUNTCOLLECTION},#{DISCOUNT_MONEY},#{DISCOUNT_MODE},#{STUDENT_BM_PKID},
		#{T_PAY_ITEM_PKID},SYSDATE,SYSDATE)
	</insert>
	
	 <!--查询缴费项目  -->
    <select id="getPayItemListByPkid"  parameterType="pd" resultType="pd">
    	SELECT * FROM T_PAY_ITEM_LIST T WHERE T.PKID = #{PKID}
    </select>
    
	 <!--根据学生副表STUDENT_BM_PKID查询缴费项目list  -->
    <select id="getPayItemListByBmPkid"  parameterType="pd" resultType="pd">
    	SELECT * FROM T_PAY_ITEM_LIST T WHERE T.STUDENT_PKID = #{STUDENT_PKID} AND T.STATUS !='3'
    </select>
    
	 <!--根据学生副表STUDENT_BM_PKID查询缴费项目list  -->
    <select id="getPayStyleByPkid"  parameterType="pd" resultType="pd">
    	SELECT * FROM T_PAY_ITEM TP LEFT JOIN T_PAY_STYLE TS ON TP.PAY_TYPE_PKID = TS.PKID 
          WHERE TP.PKID = #{T_PAY_ITEM_PKID}
    </select>
    
	 <!--删除缴费项目  -->
    <select id="deletePayItemListByPkid"  parameterType="pd" resultType="pd">
    	DELETE FROM T_PAY_ITEM_LIST T WHERE T.PKID = #{PKID}
    </select>
    
     <!-- 关闭激活缴费项 -->
	<update id="updatePayItemListStatus" parameterType="pd">
	 UPDATE T_PAY_ITEM_LIST 
			SET 
            STATUS = #{STATUS},
			XGSJ = SYSDATE
	  WHERE PKID = #{PKID}	
	</update>
	
	 <delete id="deletePayItemListbypkid" parameterType="pd">
    	DELETE FROM T_PAY_ITEM_LIST WHERE PKID=#{pkid}
    	
    </delete>
    
    <insert id="savePayItemListbypkidDel" parameterType="String" useGeneratedKeys="false">
		 Insert into T_PAY_ITEM_LIST_DEL
		(PKID,STUDENT_PKID,STATUS,COST,DISCOUNT,AMOUNTRECEIVABLE,AMOUNTCOLLECTION,
		DISCOUNT_MONEY,DISCOUNT_MODE,STUDENT_BM_PKID,T_PAY_ITEM_PKID)
		   select sys_guid(),r.STUDENT_PKID,r.STATUS,r.COST,r.DISCOUNT,r.AMOUNTRECEIVABLE,r.AMOUNTCOLLECTION,
       r.DISCOUNT_MONEY,r.DISCOUNT_MODE,r.STUDENT_BM_PKID,r.T_PAY_ITEM_PKID from 
       T_PAY_ITEM_LIST r where  r.pkid=#{pkid}
	</insert>
	
	<insert id="insertPayItemListCHANGELOG" parameterType="pd">
	  insert into t_pay_item_list_changelog
  (pkid, xgsj, cjsj, yysje, tzhje, chae,  bdlx, t_pay_item_list_pkid, ccz)
values
  (sys_guid(), SYSDATE, SYSDATE, #{AMOUNTRECEIVABLE}, #{TZHMONEY}, #{CHAE}, '2', #{T_PAY_ITEM_LIST_PKID}, #{CCZ})

 	</insert>
 	
 	<update id="updatePayItemListTZ" parameterType="pd">
    	update T_PAY_ITEM_LIST
    	set 
    	XGSJ=SYSDATE
    	<if test="TZHMONEY!=null and TZHMONEY!=''">
    		,AMOUNTRECEIVABLE=#{TZHMONEY}
    		,COST=#{TZHMONEY}
    	</if>
    	<if test="STATUS!=null and STATUS!=''">
    		,STATUS=#{STATUS}
    	</if>
    	WHERE PKID=#{T_PAY_ITEM_LIST_PKID}
    	
    </update>
    
     <select id="getPayItemListInfoTZ" parameterType="pd" resultType="pd">
    	select AMOUNTRECEIVABLE,AMOUNTCOLLECTION from T_PAY_ITEM_LIST 
    	where 1=1 
    	and PKID=#{T_PAY_ITEM_LIST_PKID} 
    </select>
    
    <insert id="insertPayItemListCHANGELOGJM" parameterType="pd">
	     insert into t_pay_item_list_changelog
     (pkid,
      xgsj,
      cjsj,
      yhsm,
      yysje,
      tzhje,
      chae,
      jbr,
      bdlx,
      t_pay_item_list_pkid,
      ccz)
   values
     (sys_guid(),
      SYSDATE,
      SYSDATE,
      #{jmdjYHSM},
      #{jmdjAMOUNTRECEIVABLE},
      #{jmdjTZHMONEY},
      #{CHAE},
      #{jmdjJBR},
      '1',
      #{T_PAY_ITEM_LIST_PKID},
      #{CCZ})
 	</insert>
 	<update id="updatePayItemListJM" parameterType="pd">
    	update T_PAY_ITEM_LIST
    	set 
    	XGSJ=SYSDATE
    	<if test="jmdjTZHMONEY!=null and jmdjTZHMONEY!=''">
    		,AMOUNTRECEIVABLE=#{jmdjTZHMONEY}
    		,COST=#{jmdjTZHMONEY}
    	</if>
    	<if test="STATUS!=null and STATUS!=''">
    		,STATUS=#{STATUS}
    	</if>
    	WHERE PKID=#{T_PAY_ITEM_LIST_PKID}
    	
    </update>
	
	

	<update id="updateItemListStatus" parameterType="pd" >
		UPDATE T_PAY_ITEM_LIST L SET L.STATUS= #{STATUS},L.XGSJ = SYSDATE
		WHERE L.PKID = #{PKID}
	</update>
	<update id="updateStuTuiXue" parameterType="pd">
		UPDATE T_STUDENT_BM SB 
		SET SB.ZXZT = 'TX',
		XGSJ = SYSDATE
		WHERE SB.PKID = #{T_STUDENT_BM_PKID}
	</update>
</mapper>